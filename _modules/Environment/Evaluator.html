

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38514290-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Environment.Evaluator &mdash; SMPyBandits 0.9.5 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> SMPyBandits
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html"><em>SMPyBandits</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/modules.html">SMPyBandits modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../How_to_run_the_code.html">How to run the code ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PublicationsWithSMPyBandits.html">List of research publications using Lilian Bessonâ€™s SMPyBandits project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Aggregation.html"><strong>Policy aggregation algorithms</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MultiPlayers.html"><strong>Multi-players simulation environment</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DoublingTrick.html"><strong>Doubling Trick for Multi-Armed Bandits</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SparseBandits.html"><strong>Structure and Sparsity of Stochastic Multi-Armed Bandits</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NonStationaryBandits.html"><strong>Non-Stationary Stochastic Multi-Armed Bandits</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../API.html">Short documentation of the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../About_parallel_computations.html">About parallel computations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO.html">ðŸ’¥ TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/README.html">Some illustrations for this project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/README.html">Jupyter Notebooks ðŸ““ by Naereen &#64; GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/list.html">List of notebooks for SMPyBandits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Profiling.html">A note on execution times, speed and profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uml_diagrams/README.html">UML diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logs/README.html"><code class="docutils literal notranslate"><span class="pre">logs</span></code> files</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SMPyBandits</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>Environment.Evaluator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Environment.Evaluator</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; Evaluator class to wrap and run the simulations.</span>
<span class="sd">Lots of plotting methods, to have various visualizations.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>  <span class="c1"># Python 2 compatibility</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Lilian Besson&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.9&quot;</span>

<span class="c1"># Generic imports</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="n">USE_PICKLE</span> <span class="o">=</span> <span class="kc">False</span>   <span class="c1">#: Should we save the figure objects to a .pickle file at the end of the simulation?</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="c1"># Scientific imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<div class="viewcode-block" id="_nbOfArgs"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator._nbOfArgs">[docs]</a><span class="k">def</span> <span class="nf">_nbOfArgs</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">function</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">)</span></div>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Local imports, libraries</span>
    <span class="kn">from</span> <span class="nn">.usejoblib</span> <span class="k">import</span> <span class="n">USE_JOBLIB</span><span class="p">,</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
    <span class="kn">from</span> <span class="nn">.usetqdm</span> <span class="k">import</span> <span class="n">USE_TQDM</span><span class="p">,</span> <span class="n">tqdm</span>
    <span class="c1"># Local imports, tools and config</span>
    <span class="kn">from</span> <span class="nn">.plotsettings</span> <span class="k">import</span> <span class="n">BBOX_INCHES</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">maximizeWindow</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">makemarkers</span><span class="p">,</span> <span class="n">add_percent_formatter</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">show_and_save</span><span class="p">,</span> <span class="n">nrows_ncols</span><span class="p">,</span> <span class="n">violin_or_box_plot</span><span class="p">,</span> <span class="n">adjust_xticks_subplots</span><span class="p">,</span> <span class="n">table_to_latex</span>
    <span class="kn">from</span> <span class="nn">.sortedDistance</span> <span class="k">import</span> <span class="n">weightedDistance</span><span class="p">,</span> <span class="n">manhattan</span><span class="p">,</span> <span class="n">kendalltau</span><span class="p">,</span> <span class="n">spearmanr</span><span class="p">,</span> <span class="n">gestalt</span><span class="p">,</span> <span class="n">meanDistance</span><span class="p">,</span> <span class="n">sortedDistance</span>
    <span class="c1"># Local imports, objects and functions</span>
    <span class="kn">from</span> <span class="nn">.MAB</span> <span class="k">import</span> <span class="n">MAB</span><span class="p">,</span> <span class="n">MarkovianMAB</span><span class="p">,</span> <span class="n">ChangingAtEachRepMAB</span><span class="p">,</span> <span class="n">NonStationaryMAB</span><span class="p">,</span> <span class="n">PieceWiseStationaryMAB</span><span class="p">,</span> <span class="n">IncreasingMAB</span>
    <span class="kn">from</span> <span class="nn">.Result</span> <span class="k">import</span> <span class="n">Result</span>
    <span class="kn">from</span> <span class="nn">.memory_consumption</span> <span class="k">import</span> <span class="n">getCurrentMemory</span><span class="p">,</span> <span class="n">sizeof_fmt</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Local imports, libraries</span>
    <span class="kn">from</span> <span class="nn">usejoblib</span> <span class="k">import</span> <span class="n">USE_JOBLIB</span><span class="p">,</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
    <span class="kn">from</span> <span class="nn">usetqdm</span> <span class="k">import</span> <span class="n">USE_TQDM</span><span class="p">,</span> <span class="n">tqdm</span>
    <span class="c1"># Local imports, tools and config</span>
    <span class="kn">from</span> <span class="nn">plotsettings</span> <span class="k">import</span> <span class="n">BBOX_INCHES</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">maximizeWindow</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">makemarkers</span><span class="p">,</span> <span class="n">add_percent_formatter</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">show_and_save</span><span class="p">,</span> <span class="n">nrows_ncols</span><span class="p">,</span> <span class="n">violin_or_box_plot</span><span class="p">,</span> <span class="n">adjust_xticks_subplots</span><span class="p">,</span> <span class="n">table_to_latex</span>
    <span class="kn">from</span> <span class="nn">sortedDistance</span> <span class="k">import</span> <span class="n">weightedDistance</span><span class="p">,</span> <span class="n">manhattan</span><span class="p">,</span> <span class="n">kendalltau</span><span class="p">,</span> <span class="n">spearmanr</span><span class="p">,</span> <span class="n">gestalt</span><span class="p">,</span> <span class="n">meanDistance</span><span class="p">,</span> <span class="n">sortedDistance</span>
    <span class="c1"># Local imports, objects and functions</span>
    <span class="kn">from</span> <span class="nn">MAB</span> <span class="k">import</span> <span class="n">MAB</span><span class="p">,</span> <span class="n">MarkovianMAB</span><span class="p">,</span> <span class="n">ChangingAtEachRepMAB</span><span class="p">,</span> <span class="n">NonStationaryMAB</span><span class="p">,</span> <span class="n">PieceWiseStationaryMAB</span><span class="p">,</span> <span class="n">IncreasingMAB</span>
    <span class="kn">from</span> <span class="nn">Result</span> <span class="k">import</span> <span class="n">Result</span>
    <span class="kn">from</span> <span class="nn">memory_consumption</span> <span class="k">import</span> <span class="n">getCurrentMemory</span><span class="p">,</span> <span class="n">sizeof_fmt</span>


<span class="n">REPETITIONS</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c1">#: Default nb of repetitions</span>
<span class="n">DELTA_T_PLOT</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1">#: Default sampling rate for plotting</span>

<span class="n">plot_lowerbound</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1">#: Default is to plot the lower-bound</span>

<span class="n">USE_BOX_PLOT</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: True to use boxplot, False to use violinplot.</span>
<span class="n">USE_BOX_PLOT</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1">#: True to use boxplot, False to use violinplot.</span>

<span class="c1"># Parameters for the random events</span>
<span class="n">random_shuffle</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: Use basic random events of shuffling the arms?</span>
<span class="n">random_invert</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: Use basic random events of inverting the arms?</span>
<span class="n">nb_break_points</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#: Default nb of random events</span>

<span class="c1"># Flag for experimental aspects</span>
<span class="n">STORE_ALL_REWARDS</span> <span class="o">=</span> <span class="kc">True</span>       <span class="c1">#: Store all rewards?</span>
<span class="n">STORE_ALL_REWARDS</span> <span class="o">=</span> <span class="kc">False</span>      <span class="c1">#: Store all rewards?</span>
<span class="n">STORE_REWARDS_SQUARED</span> <span class="o">=</span> <span class="kc">True</span>   <span class="c1">#: Store rewards squared?</span>
<span class="n">STORE_REWARDS_SQUARED</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: Store rewards squared?</span>
<span class="n">MORE_ACCURATE</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1">#: Use the count of selections instead of rewards for a more accurate mean/var reward measure.</span>
<span class="n">MORE_ACCURATE</span> <span class="o">=</span> <span class="kc">True</span>           <span class="c1">#: Use the count of selections instead of rewards for a more accurate mean/var reward measure.</span>
<span class="n">FINAL_RANKS_ON_AVERAGE</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1">#: Final ranks are printed based on average on last 1% rewards and not only the last rewards</span>
<span class="n">USE_JOBLIB_FOR_POLICIES</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: Don&#39;t use joblib to parallelize the simulations on various policies (we parallelize the random Monte Carlo repetitions)</span>


<div class="viewcode-block" id="Evaluator"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator">[docs]</a><span class="k">class</span> <span class="nc">Evaluator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Evaluator class to run the simulations.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Evaluator.__init__"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span>
                 <span class="n">finalRanksOnAverage</span><span class="o">=</span><span class="n">FINAL_RANKS_ON_AVERAGE</span><span class="p">,</span> <span class="n">averageOn</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">,</span>
                 <span class="n">useJoblibForPolicies</span><span class="o">=</span><span class="n">USE_JOBLIB_FOR_POLICIES</span><span class="p">,</span>
                 <span class="n">moreAccurate</span><span class="o">=</span><span class="n">MORE_ACCURATE</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">configuration</span>  <span class="c1">#: Configuration dictionnary</span>
        <span class="c1"># Attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;policies&#39;</span><span class="p">])</span>  <span class="c1">#: Number of policies</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of policies in this comparison:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">]</span>  <span class="c1">#: Horizon (number of time steps)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time horizon:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="n">REPETITIONS</span><span class="p">)</span>  <span class="c1">#: Number of repetitions</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of repetitions:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span> <span class="o">&lt;=</span> <span class="mi">10000</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delta_t_plot&#39;</span><span class="p">,</span> <span class="n">DELTA_T_PLOT</span><span class="p">)</span>  <span class="c1">#: Sampling rate for plotting</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sampling rate for plotting, delta_t_plot:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of jobs for parallelization:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">])</span>
        <span class="c1"># Parameters for the random events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_shuffle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;random_shuffle&#39;</span><span class="p">,</span> <span class="n">random_shuffle</span><span class="p">)</span>  <span class="c1">#: Random shuffling of arms?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_invert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;random_invert&#39;</span><span class="p">,</span> <span class="n">random_invert</span><span class="p">)</span>  <span class="c1">#: Random inversion of arms?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_break_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nb_break_points&#39;</span><span class="p">,</span> <span class="n">nb_break_points</span><span class="p">)</span>  <span class="c1">#: How many random events?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_lowerbound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_lowerbound&#39;</span><span class="p">,</span> <span class="n">plot_lowerbound</span><span class="p">)</span>  <span class="c1">#: Should we plot the lower-bound?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span>
        <span class="c1"># Flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moreAccurate</span> <span class="o">=</span> <span class="n">moreAccurate</span>  <span class="c1">#: Use the count of selections instead of rewards for a more accurate mean/var reward measure.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalRanksOnAverage</span> <span class="o">=</span> <span class="n">finalRanksOnAverage</span>  <span class="c1">#: Final display of ranks are done on average rewards?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">averageOn</span> <span class="o">=</span> <span class="n">averageOn</span>  <span class="c1">#: How many last steps for final rank average rewards</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useJoblibForPolicies</span> <span class="o">=</span> <span class="n">useJoblibForPolicies</span>  <span class="c1">#: Use joblib to parallelize for loop on policies (useless)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useJoblib</span> <span class="o">=</span> <span class="n">USE_JOBLIB</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span>  <span class="c1">#: Use joblib to parallelize for loop on repetitions (useful)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache_rewards&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1">#: Should we cache and precompute rewards</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_bayesian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;environment_bayesian&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1">#: Is the environment Bayesian?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;showplot&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1">#: Show the plot (interactive display or not)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_box_plot</span> <span class="o">=</span> <span class="n">USE_BOX_PLOT</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1">#: To use box plot (or violin plot if False). Force to use boxplot if repetitions=1.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">change_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;change_labels&#39;</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1">#: Possibly empty dictionary to map &#39;policyId&#39; to new labels (overwrite their name).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;append_labels&#39;</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1">#: Possibly empty dictionary to map &#39;policyId&#39; to new labels (by appending the result from &#39;append_labels&#39;).</span>

        <span class="c1"># Internal object memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#: List of environments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#: List of policies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initEnvironments__</span><span class="p">()</span>

        <span class="c1"># Update signature for non stationary problems</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_break_points</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">changePoints</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;changePoints&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">changePoints</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">tau</span> <span class="k">for</span> <span class="n">tau</span> <span class="ow">in</span> <span class="n">changePoints</span> <span class="k">if</span> <span class="n">tau</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_shuffle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;, $\Upsilon_T=</span><span class="si">{}</span><span class="s2">$ random arms shuffling&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">changePoints</span><span class="p">)))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_invert</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;, $\Upsilon_T=</span><span class="si">{}</span><span class="s2">$ arms inversion&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">changePoints</span><span class="p">)))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span>
            <span class="c1"># else:</span>
            <span class="c1">#     # self.signature = (r&quot;, $\Upsilon_T={}$ change point{}{}&quot;.format(len(changePoints), &quot;s&quot; if len(changePoints) &gt; 1 else &quot;&quot;, &quot; ${}$&quot;.format(list(changePoints)) if len(changePoints) &gt; 0 else &quot;&quot;) + self.signature)</span>
            <span class="c1">#     self.signature = (r&quot;, $\Upsilon_T={}$&quot;.format(len(changePoints)) + self.signature)</span>

        <span class="c1"># Internal vectorial memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">))</span>  <span class="c1">#: For each env, history of rewards, ie accumulated rewards</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastCumRewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span>  <span class="c1">#: For each env, last accumulated rewards, to compute variance and histogram of whole regret R_T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minCumRewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">),</span> <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>  <span class="c1">#: For each env, history of minimum of rewards, to compute amplitude (+- STD)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxCumRewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>  <span class="c1">#: For each env, history of maximum of rewards, to compute amplitude (+- STD)</span>

        <span class="k">if</span> <span class="n">STORE_REWARDS_SQUARED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rewardsSquared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">))</span>  <span class="c1">#: For each env, history of rewards squared</span>
        <span class="k">if</span> <span class="n">STORE_ALL_REWARDS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allRewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span>  <span class="c1">#: For each env, full history of rewards</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bestArmPulls</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1">#: For each env, keep the history of best arm pulls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pulls</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1">#: For each env, keep cumulative counts of all arm pulls</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moreAccurate</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allPulls</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1">#: For each env, keep cumulative counts of all arm pulls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastPulls</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1">#: For each env, keep cumulative counts of all arm pulls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningTimes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1">#: For each env, keep the history of running times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memoryConsumption</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1">#: For each env, keep the history of running times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numberOfCPDetections</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1">#: For each env, store the number of change-point detections by each algorithms, to print it&#39;s average at the end (to check if a certain Change-Point detector algorithm detects too few or too many changes).</span>
        <span class="c1"># XXX: WARNING no memorized vectors should have dimension duration * repetitions, that explodes the RAM consumption!</span>
        <span class="k">for</span> <span class="n">envId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bestArmPulls</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pulls</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moreAccurate</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allPulls</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastPulls</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runningTimes</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memoryConsumption</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numberOfCPDetections</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of environments to try:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">))</span>
        <span class="c1"># To speed up plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span></div>

    <span class="c1"># --- Init methods</span>

<div class="viewcode-block" id="Evaluator.__initEnvironments__"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.__initEnvironments__">[docs]</a>    <span class="k">def</span> <span class="nf">__initEnvironments__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create environments.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">configuration_arms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using this dictionary to create a new environment:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">configuration_arms</span><span class="p">)</span>  <span class="c1"># DEBUG</span>
            <span class="n">new_mab_problem</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configuration_arms</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="s2">&quot;arm_type&quot;</span> <span class="ow">in</span> <span class="n">configuration_arms</span> \
                <span class="ow">and</span> <span class="s2">&quot;params&quot;</span> <span class="ow">in</span> <span class="n">configuration_arms</span><span class="p">:</span>
                <span class="c1"># PieceWiseStationaryMAB or NonStationaryMAB or ChangingAtEachRepMAB</span>
                <span class="k">if</span> <span class="s2">&quot;listOfMeans&quot;</span>  <span class="ow">in</span> <span class="n">configuration_arms</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="s2">&quot;changePoints&quot;</span> <span class="ow">in</span> <span class="n">configuration_arms</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]:</span>
                        <span class="n">new_mab_problem</span> <span class="o">=</span> <span class="n">PieceWiseStationaryMAB</span><span class="p">(</span><span class="n">configuration_arms</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;newMeans&quot;</span> <span class="ow">in</span> <span class="n">configuration_arms</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">configuration_arms</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s2">&quot;changePoints&quot;</span> <span class="ow">in</span> <span class="n">configuration_arms</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]:</span>
                        <span class="n">new_mab_problem</span> <span class="o">=</span> <span class="n">NonStationaryMAB</span><span class="p">(</span><span class="n">configuration_arms</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_mab_problem</span> <span class="o">=</span> <span class="n">ChangingAtEachRepMAB</span><span class="p">(</span><span class="n">configuration_arms</span><span class="p">)</span>
                <span class="c1"># MarkovianMAB</span>
                <span class="k">elif</span> <span class="n">configuration_arms</span><span class="p">[</span><span class="s2">&quot;arm_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Markovian&quot;</span> \
                    <span class="ow">and</span> <span class="s2">&quot;transitions&quot;</span> <span class="ow">in</span> <span class="n">configuration_arms</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]:</span>
                    <span class="n">new_mab_problem</span> <span class="o">=</span> <span class="n">MarkovianMAB</span><span class="p">(</span><span class="n">configuration_arms</span><span class="p">)</span>
                <span class="c1"># IncreasingMAB</span>
                <span class="k">elif</span> <span class="s2">&quot;change_lower_amplitude&quot;</span> <span class="ow">in</span> <span class="n">configuration_arms</span><span class="p">:</span>
                    <span class="n">new_mab_problem</span> <span class="o">=</span> <span class="n">IncreasingMAB</span><span class="p">(</span><span class="n">configuration_arms</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_mab_problem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_mab_problem</span> <span class="o">=</span> <span class="n">MAB</span><span class="p">(</span><span class="n">configuration_arms</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_mab_problem</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.__initPolicies__"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.__initPolicies__">[docs]</a>    <span class="k">def</span> <span class="nf">__initPolicies__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create or initialize policies.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;policies&#39;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Adding policy #</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">policy</span><span class="p">))</span>  <span class="c1"># DEBUG</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Creating this policy from a dictionnary &#39;self.cfg[&#39;policies&#39;][</span><span class="si">{}</span><span class="s2">]&#39; = </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span><span class="p">))</span>  <span class="c1"># DEBUG</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">policy</span><span class="p">[</span><span class="s1">&#39;archtype&#39;</span><span class="p">](</span><span class="n">env</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="o">**</span><span class="n">policy</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Using this already created policy &#39;self.cfg[&#39;policies&#39;][</span><span class="si">{}</span><span class="s2">]&#39; = </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span><span class="p">))</span>  <span class="c1"># DEBUG</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policyId</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_labels</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_labels</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_labels</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_labels</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span></div>


    <span class="c1"># --- Start computation</span>

<div class="viewcode-block" id="Evaluator.compute_cache_rewards"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.compute_cache_rewards">[docs]</a>    <span class="k">def</span> <span class="nf">compute_cache_rewards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute only once the rewards, then launch the experiments with the same matrix (r_{k,t}).&quot;&quot;&quot;</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">arms</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">===&gt; Pre-computing the rewards ... Of shape </span><span class="si">{}</span><span class="s2"> ...</span><span class="se">\n</span><span class="s2">    In order for all simulated algorithms to face the same random rewards (robust comparison of A1,..,An vs Aggr(A1,..,An)) ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">rewards</span><span class="p">)))</span>  <span class="c1"># DEBUG</span>
        <span class="k">for</span> <span class="n">armId</span><span class="p">,</span> <span class="n">arm</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">arms</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Arms&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arm</span><span class="p">,</span> <span class="s1">&#39;draw_nparray&#39;</span><span class="p">):</span>  <span class="c1"># XXX Use this method to speed up computation</span>
                <span class="n">rewards</span><span class="p">[</span><span class="n">armId</span><span class="p">]</span> <span class="o">=</span> <span class="n">arm</span><span class="o">.</span><span class="n">draw_nparray</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Slower</span>
                <span class="k">for</span> <span class="n">repeatId</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Repetitions&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Time steps&quot;</span><span class="p">):</span>
                        <span class="n">rewards</span><span class="p">[</span><span class="n">armId</span><span class="p">,</span> <span class="n">repeatId</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">arm</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rewards</span></div>

<div class="viewcode-block" id="Evaluator.startAllEnv"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.startAllEnv">[docs]</a>    <span class="k">def</span> <span class="nf">startAllEnv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate all envs.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">envId</span><span class="p">,</span> <span class="n">env</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startOneEnv</span><span class="p">(</span><span class="n">envId</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.startOneEnv"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.startOneEnv">[docs]</a>    <span class="k">def</span> <span class="nf">startOneEnv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate that env.&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Evaluating environment:&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">env</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initPolicies__</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="c1"># Precompute rewards</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_rewards</span><span class="p">:</span>
            <span class="n">allrewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_cache_rewards</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">arms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allrewards</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">repeatId</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Store the result of the #repeatId experiment, for the #policyId policy.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">rewards</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastCumRewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="n">repeatId</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rewards</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rewardsSquared&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rewardsSquared</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rewards</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;allRewards&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allRewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:,</span> <span class="n">repeatId</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">rewards</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;minCumRewards&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">minCumRewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minCumRewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rewards</span><span class="p">))</span> <span class="k">if</span> <span class="n">repeatId</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rewards</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;maxCumRewards&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">maxCumRewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxCumRewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rewards</span><span class="p">))</span> <span class="k">if</span> <span class="n">repeatId</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rewards</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bestArmPulls</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">indexes_bestarm</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pulls</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">pulls</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moreAccurate</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allPulls</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">choices</span> <span class="o">==</span> <span class="n">armId</span><span class="p">)</span> <span class="k">for</span> <span class="n">armId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">nbArms</span><span class="p">)])</span>  <span class="c1"># XXX consumes a lot of zeros but it is not so costly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memoryConsumption</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="n">repeatId</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">memory_consumption</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastPulls</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="p">:,</span> <span class="n">repeatId</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">pulls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runningTimes</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="n">repeatId</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">running_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numberOfCPDetections</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="n">repeatId</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">number_of_cp_detections</span>

        <span class="c1"># Start for all policies</span>
        <span class="k">for</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">- Evaluating policy #</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">,</span> <span class="n">policy</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useJoblib</span><span class="p">:</span>
                <span class="n">seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
                <span class="n">repeatIdout</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">],</span> <span class="n">pre_dispatch</span><span class="o">=</span><span class="s1">&#39;3*n_jobs&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;verbosity&#39;</span><span class="p">])(</span>
                    <span class="n">delayed</span><span class="p">(</span><span class="n">delayed_play</span><span class="p">)(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">random_shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_shuffle</span><span class="p">,</span> <span class="n">random_invert</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_invert</span><span class="p">,</span> <span class="n">nb_break_points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_break_points</span><span class="p">,</span> <span class="n">allrewards</span><span class="o">=</span><span class="n">allrewards</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seeds</span><span class="p">[</span><span class="n">repeatId</span><span class="p">],</span> <span class="n">repeatId</span><span class="o">=</span><span class="n">repeatId</span><span class="p">,</span> <span class="n">useJoblib</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">useJoblib</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">repeatId</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Repeat||&quot;</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">store</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">repeatIdout</span><span class="p">)</span>
                    <span class="n">repeatIdout</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">repeatId</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Repeat&quot;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">delayed_play</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">random_shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_shuffle</span><span class="p">,</span> <span class="n">random_invert</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_invert</span><span class="p">,</span> <span class="n">nb_break_points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_break_points</span><span class="p">,</span> <span class="n">allrewards</span><span class="o">=</span><span class="n">allrewards</span><span class="p">,</span> <span class="n">repeatId</span><span class="o">=</span><span class="n">repeatId</span><span class="p">,</span> <span class="n">useJoblib</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">useJoblib</span><span class="p">)</span>
                    <span class="n">store</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">repeatId</span><span class="p">)</span></div>

    <span class="c1"># --- Save to disk methods</span>

<div class="viewcode-block" id="Evaluator.saveondisk"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.saveondisk">[docs]</a>    <span class="k">def</span> <span class="nf">saveondisk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="s2">&quot;saveondisk_Evaluator.hdf5&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the content of the internal data to into a HDF5 file on the disk.</span>

<span class="sd">        - See http://docs.h5py.org/en/stable/quick.html if needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">h5py</span>
        <span class="c1"># 1. create the h5py file</span>
        <span class="n">h5file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="c1"># 2. store main attributes and all other attributes, if they exist</span>
        <span class="k">for</span> <span class="n">name_of_attr</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;horizon&quot;</span><span class="p">,</span> <span class="s2">&quot;repetitions&quot;</span><span class="p">,</span> <span class="s2">&quot;nbPolicies&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delta_t_plot&quot;</span><span class="p">,</span> <span class="s2">&quot;random_shuffle&quot;</span><span class="p">,</span> <span class="s2">&quot;random_invert&quot;</span><span class="p">,</span> <span class="s2">&quot;nb_break_points&quot;</span><span class="p">,</span> <span class="s2">&quot;plot_lowerbound&quot;</span><span class="p">,</span> <span class="s2">&quot;signature&quot;</span><span class="p">,</span> <span class="s2">&quot;moreAccurate&quot;</span><span class="p">,</span> <span class="s2">&quot;finalRanksOnAverage&quot;</span><span class="p">,</span> <span class="s2">&quot;averageOn&quot;</span><span class="p">,</span> <span class="s2">&quot;useJoblibForPolicies&quot;</span><span class="p">,</span> <span class="s2">&quot;useJoblib&quot;</span><span class="p">,</span> <span class="s2">&quot;cache_rewards&quot;</span><span class="p">,</span> <span class="s2">&quot;environment_bayesian&quot;</span><span class="p">,</span> <span class="s2">&quot;showplot&quot;</span><span class="p">,</span> <span class="s2">&quot;change_labels&quot;</span><span class="p">,</span> <span class="s2">&quot;append_labels&quot;</span>
            <span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_of_attr</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_of_attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">string_</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">h5file</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">name_of_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: when saving the Evaluator object to a HDF5 file, the attribute named </span><span class="si">{}</span><span class="s2"> (value </span><span class="si">{}</span><span class="s2"> of type </span><span class="si">{}</span><span class="s2">) couldn&#39;t be saved. Skipping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_of_attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>  <span class="c1"># DEBUG</span>

        <span class="c1"># 2.bis. store list of names of policies</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">string_</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">)</span> <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="p">]</span>
        <span class="n">h5file</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>

        <span class="c1"># 3. store some arrays that are shared between envs?</span>
        <span class="k">for</span> <span class="n">name_of_dataset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rewards&quot;</span><span class="p">,</span> <span class="s2">&quot;rewardsSquared&quot;</span><span class="p">,</span> <span class="s2">&quot;allRewards&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_of_dataset</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_of_dataset</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">h5file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name_of_dataset</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: when saving the Evaluator object to a HDF5 file, the dataset named </span><span class="si">{}</span><span class="s2"> (value of type </span><span class="si">{}</span><span class="s2"> and shape </span><span class="si">{}</span><span class="s2"> and dtype </span><span class="si">{}</span><span class="s2">) couldn&#39;t be saved. Skipping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_of_dataset</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>  <span class="c1"># DEBUG</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>  <span class="c1"># DEBUG</span>

        <span class="c1"># 4. for each environment</span>
        <span class="n">h5file</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;number_of_envs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">envId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">)):</span>
            <span class="c1"># 4.a. create subgroup for this env</span>
            <span class="n">sbgrp</span> <span class="o">=</span> <span class="n">h5file</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;env_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">envId</span><span class="p">))</span>
            <span class="c1"># 4.b. store attribute of the MAB problem</span>
            <span class="n">mab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name_of_attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;isChangingAtEachRepetition&quot;</span><span class="p">,</span> <span class="s2">&quot;isMarkovian&quot;</span><span class="p">,</span> <span class="s2">&quot;_sparsity&quot;</span><span class="p">,</span> <span class="s2">&quot;means&quot;</span><span class="p">,</span> <span class="s2">&quot;nbArms&quot;</span><span class="p">,</span> <span class="s2">&quot;maxArm&quot;</span><span class="p">,</span> <span class="s2">&quot;minArm&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mab</span><span class="p">,</span> <span class="n">name_of_attr</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mab</span><span class="p">,</span> <span class="n">name_of_attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">string_</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">sbgrp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">name_of_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: when saving the Evaluator object to a HDF5 file, the attribute named </span><span class="si">{}</span><span class="s2"> (value </span><span class="si">{}</span><span class="s2"> of type </span><span class="si">{}</span><span class="s2">) couldn&#39;t be saved. Skipping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_of_attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>  <span class="c1"># DEBUG</span>
            <span class="c1"># 4.c. store data for that env</span>
            <span class="k">for</span> <span class="n">name_of_dataset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;allPulls&quot;</span><span class="p">,</span> <span class="s2">&quot;lastPulls&quot;</span><span class="p">,</span> <span class="s2">&quot;runningTimes&quot;</span><span class="p">,</span> <span class="s2">&quot;memoryConsumption&quot;</span><span class="p">,</span> <span class="s2">&quot;numberOfCPDetections&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_of_dataset</span><span class="p">)</span> <span class="ow">and</span> <span class="n">envId</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_of_dataset</span><span class="p">)</span> <span class="p">):</span> <span class="k">continue</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_of_dataset</span><span class="p">)[</span><span class="n">envId</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">sbgrp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name_of_dataset</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: when saving the Evaluator object to a HDF5 file, the dataset named </span><span class="si">{}</span><span class="s2"> (value of type </span><span class="si">{}</span><span class="s2"> and shape </span><span class="si">{}</span><span class="s2"> and dtype </span><span class="si">{}</span><span class="s2">) couldn&#39;t be saved. Skipping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_of_dataset</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>  <span class="c1"># DEBUG</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>  <span class="c1"># DEBUG</span>

            <span class="c1"># 4.d. compute and store data for that env</span>
            <span class="k">for</span> <span class="n">methodName</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;getRunningTimes&quot;</span><span class="p">,</span> <span class="s2">&quot;getMemoryConsumption&quot;</span><span class="p">,</span> <span class="s2">&quot;getNumberOfCPDetections&quot;</span><span class="p">,</span> <span class="s2">&quot;getBestArmPulls&quot;</span><span class="p">,</span> <span class="s2">&quot;getPulls&quot;</span><span class="p">,</span> <span class="s2">&quot;getRewards&quot;</span><span class="p">,</span> <span class="s2">&quot;getCumulatedRegret&quot;</span><span class="p">,</span> <span class="s2">&quot;getLastRegrets&quot;</span><span class="p">,</span> <span class="s2">&quot;getAverageRewards&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">name_of_dataset</span> <span class="o">=</span> <span class="n">methodName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">name_of_dataset</span> <span class="o">=</span> <span class="n">name_of_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="n">name_of_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">name_of_dataset</span> <span class="ow">in</span> <span class="n">sbgrp</span><span class="p">:</span> <span class="n">name_of_dataset</span> <span class="o">=</span> <span class="n">methodName</span>  <span class="c1"># XXX be sure to not use twice the same name, e.g., for getRunningTimes and runningTimes</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_nbOfArgs</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">method</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">))])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">method</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">)</span> <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">))])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">(</span><span class="n">envId</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">envId</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">envId</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">sbgrp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name_of_dataset</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: when saving the Evaluator object to a HDF5 file, the dataset named </span><span class="si">{}</span><span class="s2"> (value of type </span><span class="si">{}</span><span class="s2"> and shape </span><span class="si">{}</span><span class="s2"> and dtype </span><span class="si">{}</span><span class="s2">) couldn&#39;t be saved. Skipping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_of_dataset</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>  <span class="c1"># DEBUG</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>  <span class="c1"># DEBUG</span>

        <span class="c1"># 5. when done, close the file</span>
        <span class="n">h5file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1"># def loadfromdisk(self, filepath):</span>
    <span class="c1">#     &quot;&quot;&quot; Update internal memory of the Evaluator object by loading data the opened HDF5 file.</span>

    <span class="c1">#     .. warning:: FIXME this is not YET implemented!</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # FIXME I just have to fill all the internal matrices from the HDF5 file ?</span>
    <span class="c1">#     raise NotImplementedError</span>

    <span class="c1"># --- Get data</span>

<div class="viewcode-block" id="Evaluator.getPulls"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getPulls">[docs]</a>    <span class="k">def</span> <span class="nf">getPulls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract mean pulls.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulls</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.getBestArmPulls"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getBestArmPulls">[docs]</a>    <span class="k">def</span> <span class="nf">getBestArmPulls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract mean best arm pulls.&quot;&quot;&quot;</span>
        <span class="c1"># We have to divide by a arange() = cumsum(ones) to get a frequency</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestArmPulls</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_times</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.getRewards"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getRewards">[docs]</a>    <span class="k">def</span> <span class="nf">getRewards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract mean rewards.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.getAverageWeightedSelections"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getAverageWeightedSelections">[docs]</a>    <span class="k">def</span> <span class="nf">getAverageWeightedSelections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract weighted count of selections.&quot;&quot;&quot;</span>
        <span class="n">weighted_selections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">armId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">):</span>
            <span class="n">mean_selections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allPulls</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="n">armId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
            <span class="c1"># DONE this is now fixed for non-stationary bandits</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">],</span> <span class="s1">&#39;get_allMeans&#39;</span><span class="p">):</span>
                <span class="n">meanOfThisArm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">get_allMeans</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)[</span><span class="n">armId</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">meanOfThisArm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">armId</span><span class="p">]</span>
            <span class="n">weighted_selections</span> <span class="o">+=</span> <span class="n">meanOfThisArm</span> <span class="o">*</span> <span class="n">mean_selections</span>
        <span class="k">return</span> <span class="n">weighted_selections</span></div>

<div class="viewcode-block" id="Evaluator.getMaxRewards"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getMaxRewards">[docs]</a>    <span class="k">def</span> <span class="nf">getMaxRewards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract max mean rewards.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rewards</span><span class="p">[:,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span></div>

<div class="viewcode-block" id="Evaluator.getCumulatedRegret_LessAccurate"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getCumulatedRegret_LessAccurate">[docs]</a>    <span class="k">def</span> <span class="nf">getCumulatedRegret_LessAccurate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute cumulative regret, based on accumulated rewards.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">get_maxArm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRewards</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">))</span></div>

<div class="viewcode-block" id="Evaluator.getCumulatedRegret_MoreAccurate"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getCumulatedRegret_MoreAccurate">[docs]</a>    <span class="k">def</span> <span class="nf">getCumulatedRegret_MoreAccurate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute cumulative regret, based on counts of selections and not actual rewards.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">moreAccurate</span><span class="p">,</span> <span class="s2">&quot;Error: getCumulatedRegret_MoreAccurate() is only available when using the &#39;moreAccurate&#39; option (it consumes more memory!).&quot;</span>  <span class="c1"># DEBUG</span>
        <span class="n">instant_oracle_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">get_maxArm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span>
        <span class="n">instant_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAverageWeightedSelections</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">)</span>
        <span class="n">instant_loss</span> <span class="o">=</span> <span class="n">instant_oracle_performance</span> <span class="o">-</span> <span class="n">instant_performance</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">instant_loss</span><span class="p">)</span></div>
        <span class="c1"># return np.cumsum(self.envs[envId].get_maxArm(self.horizon) - self.getAverageWeightedSelections(policyId, envId))</span>

<div class="viewcode-block" id="Evaluator.getCumulatedRegret"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getCumulatedRegret">[docs]</a>    <span class="k">def</span> <span class="nf">getCumulatedRegret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Using either the more accurate or the less accurate regret count.&quot;&quot;&quot;</span>
        <span class="n">moreAccurate</span> <span class="o">=</span> <span class="n">moreAccurate</span> <span class="k">if</span> <span class="n">moreAccurate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">moreAccurate</span>
        <span class="c1"># print(&quot;Computing the vector of mean cumulated regret with &#39;{}&#39; accurate method...&quot;.format(&quot;more&quot; if moreAccurate else &quot;less&quot;))  # DEBUG</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCumulatedRegret_MoreAccurate</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">)</span> <span class="k">if</span> <span class="n">moreAccurate</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCumulatedRegret_LessAccurate</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.getLastRegrets_LessAccurate"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getLastRegrets_LessAccurate">[docs]</a>    <span class="k">def</span> <span class="nf">getLastRegrets_LessAccurate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract last regrets, based on accumulated rewards.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">get_maxArm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCumRewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:]</span></div>

<div class="viewcode-block" id="Evaluator.getAllLastWeightedSelections"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getAllLastWeightedSelections">[docs]</a>    <span class="k">def</span> <span class="nf">getAllLastWeightedSelections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract weighted count of selections.&quot;&quot;&quot;</span>
        <span class="n">all_last_weighted_selections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">armId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">],</span> <span class="s1">&#39;get_allMeans&#39;</span><span class="p">):</span>
                <span class="n">meanOfThisArm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">get_allMeans</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)[</span><span class="n">armId</span><span class="p">,</span> <span class="p">:]</span>
                <span class="c1"># DONE this is now fixed for non-stationary bandits</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">meanOfThisArm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">armId</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;allPulls&#39;</span><span class="p">):</span>
                <span class="n">all_selections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allPulls</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="n">armId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">meanOfThisArm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># problem was stationary!</span>
                    <span class="n">last_selections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_selections</span><span class="p">)</span>  <span class="c1"># no variance, but we don&#39;t care!</span>
                    <span class="n">all_last_weighted_selections</span> <span class="o">+=</span> <span class="n">meanOfThisArm</span> <span class="o">*</span> <span class="n">last_selections</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># problem was non stationary!</span>
                    <span class="n">last_selections</span> <span class="o">=</span> <span class="n">all_selections</span>
                    <span class="n">all_last_weighted_selections</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">meanOfThisArm</span> <span class="o">*</span> <span class="n">last_selections</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last_selections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastPulls</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="n">armId</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">all_last_weighted_selections</span> <span class="o">+=</span> <span class="n">meanOfThisArm</span> <span class="o">*</span> <span class="n">last_selections</span>
        <span class="k">return</span> <span class="n">all_last_weighted_selections</span></div>

<div class="viewcode-block" id="Evaluator.getLastRegrets_MoreAccurate"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getLastRegrets_MoreAccurate">[docs]</a>    <span class="k">def</span> <span class="nf">getLastRegrets_MoreAccurate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract last regrets, based on counts of selections and not actual rewards.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">get_maxArm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAllLastWeightedSelections</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.getLastRegrets"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getLastRegrets">[docs]</a>    <span class="k">def</span> <span class="nf">getLastRegrets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Using either the more accurate or the less accurate regret count.&quot;&quot;&quot;</span>
        <span class="n">moreAccurate</span> <span class="o">=</span> <span class="n">moreAccurate</span> <span class="k">if</span> <span class="n">moreAccurate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">moreAccurate</span>
        <span class="c1"># print(&quot;Computing the vector of last cumulated regrets (on repetitions) with &#39;{}&#39; accurate method...&quot;.format(&quot;more&quot; if moreAccurate else &quot;less&quot;))  # DEBUG</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastRegrets_MoreAccurate</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">)</span> <span class="k">if</span> <span class="n">moreAccurate</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastRegrets_LessAccurate</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.getAverageRewards"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getAverageRewards">[docs]</a>    <span class="k">def</span> <span class="nf">getAverageRewards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract mean rewards (not `rewards` but `cumsum(rewards)/cumsum(1)`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getRewards</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_times</span></div>

<div class="viewcode-block" id="Evaluator.getRewardsSquared"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getRewardsSquared">[docs]</a>    <span class="k">def</span> <span class="nf">getRewardsSquared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract rewards squared.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewardsSquared</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.getSTDRegret"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getSTDRegret">[docs]</a>    <span class="k">def</span> <span class="nf">getSTDRegret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">meanReward</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract standard deviation of rewards.</span>

<span class="sd">        .. warning:: FIXME experimental!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># X = self._times</span>
        <span class="c1"># YMAX = self.getMaxRewards(envId=envId)</span>
        <span class="c1"># Y = self.getRewards(policyId, envId)</span>
        <span class="c1"># Y2 = self.getRewardsSquared(policyId, envId)</span>
        <span class="c1"># if meanReward:  # Cumulated expectation on time</span>
        <span class="c1">#     Ycum2 = (np.cumsum(Y) / X)**2</span>
        <span class="c1">#     Y2cum = np.cumsum(Y2) / X</span>
        <span class="c1">#     assert np.all(Y2cum &gt;= Ycum2), &quot;Error: getSTDRegret found a nan value in the standard deviation (ie a point where Y2cum &lt; Ycum2).&quot;  # DEBUG</span>
        <span class="c1">#     stdY = np.sqrt(Y2cum - Ycum2)</span>
        <span class="c1">#     YMAX *= 20  # XXX make it look smaller, for the plots</span>
        <span class="c1"># else:  # Expectation on nb of repetitions</span>
        <span class="c1">#     # https://en.wikipedia.org/wiki/Algebraic_formula_for_the_variance#In_terms_of_raw_moments</span>
        <span class="c1">#     # std(Y) = sqrt( E[Y**2] - E[Y]**2 )</span>
        <span class="c1">#     # stdY = np.cumsum(np.sqrt(Y2 - Y**2))</span>
        <span class="c1">#     stdY = np.sqrt(Y2 - Y**2)</span>
        <span class="c1">#     YMAX *= np.log(2 + self.horizon)  # Normalize the std variation</span>
        <span class="c1">#     YMAX *= 50  # XXX make it look larger, for the plots</span>
        <span class="c1"># # Renormalize this standard deviation</span>
        <span class="c1"># # stdY /= YMAX</span>
        <span class="n">allRewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allRewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">allRewards</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.getMaxMinReward"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getMaxMinReward">[docs]</a>    <span class="k">def</span> <span class="nf">getMaxMinReward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract amplitude of rewards as maxCumRewards - minCumRewards.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxCumRewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">minCumRewards</span><span class="p">[</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span></div>
        <span class="c1"># return self.maxCumRewards[policyId, envId, :] - self.minCumRewards[policyId, envId, :]</span>

<div class="viewcode-block" id="Evaluator.getRunningTimes"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getRunningTimes">[docs]</a>    <span class="k">def</span> <span class="nf">getRunningTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the means and stds and list of running time of the different policies.&quot;&quot;&quot;</span>
        <span class="n">all_times</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningTimes</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="k">for</span> <span class="n">times</span> <span class="ow">in</span> <span class="n">all_times</span> <span class="p">]</span>
        <span class="n">stds</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="k">for</span> <span class="n">times</span> <span class="ow">in</span> <span class="n">all_times</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">all_times</span></div>

<div class="viewcode-block" id="Evaluator.getMemoryConsumption"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getMemoryConsumption">[docs]</a>    <span class="k">def</span> <span class="nf">getMemoryConsumption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the means and stds and list of memory consumptions of the different policies.&quot;&quot;&quot;</span>
        <span class="n">all_memories</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">memoryConsumption</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">):</span>
            <span class="n">all_memories</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">all_memories</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">]</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">memories</span> <span class="ow">in</span> <span class="n">all_memories</span><span class="p">]</span>
        <span class="n">stds</span>  <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">memories</span> <span class="ow">in</span> <span class="n">all_memories</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">all_memories</span></div>

<div class="viewcode-block" id="Evaluator.getNumberOfCPDetections"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.getNumberOfCPDetections">[docs]</a>    <span class="k">def</span> <span class="nf">getNumberOfCPDetections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the means and stds and list of numberOfCPDetections of the different policies.&quot;&quot;&quot;</span>
        <span class="n">all_number_of_cp_detections</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfCPDetections</span><span class="p">[</span><span class="n">envId</span><span class="p">][</span><span class="n">policyId</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">number_of_cp_detections</span><span class="p">)</span> <span class="k">for</span> <span class="n">number_of_cp_detections</span> <span class="ow">in</span> <span class="n">all_number_of_cp_detections</span> <span class="p">]</span>
        <span class="n">stds</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">number_of_cp_detections</span><span class="p">)</span> <span class="k">for</span> <span class="n">number_of_cp_detections</span> <span class="ow">in</span> <span class="n">all_number_of_cp_detections</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">all_number_of_cp_detections</span></div>

    <span class="c1"># --- Plotting methods</span>

<div class="viewcode-block" id="Evaluator.printFinalRanking"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.printFinalRanking">[docs]</a>    <span class="k">def</span> <span class="nf">printFinalRanking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the final ranking of the different policies.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Giving the final ranks ...&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">averageOn</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Error, the parameter averageOn of a EvaluatorMultiPlayers classs has to be in (0, 1) strictly, but is = </span><span class="si">{}</span><span class="s2"> here ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">averageOn</span><span class="p">)</span>  <span class="c1"># DEBUG</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Final ranking for this environment #</span><span class="si">{}</span><span class="s2"> :&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">envId</span><span class="p">))</span>
        <span class="n">nbPolicies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span>
        <span class="n">lastY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbPolicies</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCumulatedRegret</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="n">moreAccurate</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalRanksOnAverage</span><span class="p">:</span>
                <span class="n">lastY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">averageOn</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)])</span>   <span class="c1"># get average value during the last 0.5% of the iterations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lastY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># get the last value</span>
        <span class="c1"># Sort lastY and give ranking</span>
        <span class="n">index_of_sorting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lastY</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index_of_sorting</span><span class="p">):</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Policy &#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\t</span><span class="s2">was ranked</span><span class="se">\t</span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="s2"> for this simulation (last regret = </span><span class="si">{:.5g}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbPolicies</span><span class="p">,</span> <span class="n">lastY</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">lastY</span><span class="p">,</span> <span class="n">index_of_sorting</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Evaluator._xlabel"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator._xlabel">[docs]</a>    <span class="k">def</span> <span class="nf">_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add xlabel to the plot, and if the environment has change-point, draw vertical lines to clearly identify the locations of the change points.&quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;changePoints&#39;</span><span class="p">):</span>
            <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
            <span class="n">taus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">changePoints</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">taus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Adding vlines for the change points with more than 25 change points will be ugly on the plots...&quot;</span><span class="p">)</span>  <span class="c1"># DEBUG</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">taus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># Force to NOT add the vlines</span>
                <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tau</span> <span class="ow">in</span> <span class="n">taus</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tau</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tau</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.plotRegrets"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.plotRegrets">[docs]</a>    <span class="k">def</span> <span class="nf">plotRegrets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">meanReward</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">plotSTD</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plotMaxMin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">semilogx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">semilogy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loglog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">normalizedRegret</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drawUpperBound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">moreAccurate</span><span class="o">=</span><span class="kc">None</span>
                    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the centralized cumulated regret, support more than one environments (use evaluators to give a list of other environments). &quot;&quot;&quot;</span>
        <span class="n">moreAccurate</span> <span class="o">=</span> <span class="n">moreAccurate</span> <span class="k">if</span> <span class="n">moreAccurate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">moreAccurate</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">palette</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">)</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="n">makemarkers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_times</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">plot_method</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span> <span class="k">if</span> <span class="n">loglog</span> <span class="k">else</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span>
        <span class="n">plot_method</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span> <span class="k">if</span> <span class="n">semilogy</span> <span class="k">else</span> <span class="n">plot_method</span>
        <span class="n">plot_method</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span> <span class="k">if</span> <span class="n">semilogx</span> <span class="k">else</span> <span class="n">plot_method</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">meanReward</span><span class="p">:</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAverageRewards</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">envId</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCumulatedRegret</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="n">moreAccurate</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">normalizedRegret</span><span class="p">:</span>
                    <span class="n">Y</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">X</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>   <span class="c1"># XXX prevent /0</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
            <span class="n">lw</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;$N=&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="ow">or</span> <span class="s1">&#39;Aggr&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="ow">or</span> <span class="s1">&#39;CORRAL&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="ow">or</span> <span class="s1">&#39;LearnExp&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="ow">or</span> <span class="s1">&#39;Exp4&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">)</span> <span class="k">else</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span> <span class="n">lw</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">semilogx</span> <span class="ow">or</span> <span class="n">loglog</span><span class="p">:</span>
                <span class="c1"># FIXED for semilogx plots, truncate to only show t &gt;= 100</span>
                <span class="n">X_to_plot_here</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">]</span>
                <span class="n">Y_to_plot_here</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">X</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">]</span>
                <span class="n">plot_method</span><span class="p">(</span><span class="n">X_to_plot_here</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">Y_to_plot_here</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">markevery</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_method</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">Y</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">markevery</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">semilogx</span> <span class="ow">or</span> <span class="n">loglog</span><span class="p">:</span>  <span class="c1"># Manual fix for issue https://github.com/SMPyBandits/SMPyBandits/issues/38</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">semilogy</span> <span class="ow">or</span> <span class="n">loglog</span><span class="p">:</span>  <span class="c1"># Manual fix for issue https://github.com/SMPyBandits/SMPyBandits/issues/38</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="c1"># Print standard deviation of regret</span>
            <span class="k">if</span> <span class="n">plotSTD</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">stdY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSTDRegret</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="n">meanReward</span><span class="o">=</span><span class="n">meanReward</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">normalizedRegret</span><span class="p">:</span>
                    <span class="n">stdY</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">X</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">Y</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">]</span> <span class="o">-</span> <span class="n">stdY</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">Y</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">]</span> <span class="o">+</span> <span class="n">stdY</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="c1"># Print amplitude of regret</span>
            <span class="k">if</span> <span class="n">plotMaxMin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">MaxMinY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxMinReward</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">envId</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
                <span class="k">if</span> <span class="n">normalizedRegret</span><span class="p">:</span>
                    <span class="n">MaxMinY</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">X</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">Y</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">]</span> <span class="o">-</span> <span class="n">MaxMinY</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">Y</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">]</span> <span class="o">+</span> <span class="n">MaxMinY</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xlabel</span><span class="p">(</span><span class="n">envId</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;Time steps $t = 1...T$, horizon $T = </span><span class="si">{}</span><span class="s2">$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
        <span class="n">lowerbound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">lowerbound</span><span class="p">()</span>
        <span class="n">lowerbound_sparse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">lowerbound_sparse</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">semilogx</span> <span class="ow">or</span> <span class="n">semilogy</span> <span class="ow">or</span> <span class="n">loglog</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">This MAB problem has: </span><span class="se">\n</span><span class="s2"> - a [Lai &amp; Robbins] complexity constant C(mu) = </span><span class="si">{:.3g}</span><span class="s2"> for 1-player problem... </span><span class="se">\n</span><span class="s2"> - a Optimal Arm Identification factor H_OI(mu) = </span><span class="si">{:.2%}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lowerbound</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">hoifactor</span><span class="p">()))</span>  <span class="c1"># DEBUG</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">_sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lowerbound_sparse</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">- a [Kwon et al] sparse lower-bound with s = </span><span class="si">{}</span><span class="s2"> non-negative arm, C&#39;(mu) = </span><span class="si">{:.3g}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">_sparsity</span><span class="p">,</span> <span class="n">lowerbound_sparse</span><span class="p">))</span>  <span class="c1"># DEBUG</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">meanReward</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">semilogy</span> <span class="ow">or</span> <span class="n">loglog</span><span class="p">:</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymin</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Get a small string to add to ylabel</span>
        <span class="n">ylabel2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;, $\pm 1$ standard deviation&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">plotSTD</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plotMaxMin</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;, $\pm 1$ amplitude&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">plotMaxMin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plotSTD</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meanReward</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">],</span> <span class="s1">&#39;get_allMeans&#39;</span><span class="p">):</span>
                <span class="c1"># DONE this is now fixed for non-stationary bandits</span>
                <span class="n">means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">get_allMeans</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span>
                <span class="n">minArm</span><span class="p">,</span> <span class="n">maxArm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">means</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">minArm</span><span class="p">,</span> <span class="n">maxArm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">minArm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">maxArm</span>
            <span class="c1"># We plot a horizontal line ----- at the best arm mean</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">maxArm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">X</span><span class="p">)[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Largest mean = $</span><span class="si">{:.3g}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxArm</span><span class="p">))</span>
            <span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Mean reward, average on time $\tilde</span><span class="si">{r}</span><span class="s2">_t = \frac</span><span class="si">{1}{t}</span><span class="s2"> \sum_{s=1}^</span><span class="si">{t}</span><span class="s2">$ </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\sum_{k=1}^{</span><span class="si">%d</span><span class="s2">} \mu_k\mathbb</span><span class="si">{E}</span><span class="s2">_{</span><span class="si">%d</span><span class="s2">}[T_k(t)]$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="k">if</span> <span class="n">moreAccurate</span> <span class="k">else</span> <span class="sa">r</span><span class="s2">&quot;$\mathbb</span><span class="si">{E}</span><span class="s2">_{</span><span class="si">%d</span><span class="s2">}[r_s]$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">),</span> <span class="n">ylabel2</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">isChangingAtEachRepetition</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_break_points</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.80</span> <span class="o">*</span> <span class="n">minArm</span><span class="p">,</span> <span class="mf">1.10</span> <span class="o">*</span> <span class="n">maxArm</span><span class="p">)</span>
            <span class="c1"># if self.nb_break_points &gt; 0:</span>
            <span class="c1">#     plt.ylim(0, 1)  # FIXME do better!</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Mean rewards for different bandit algorithms, averaged $</span><span class="si">{}</span><span class="s2">$ times</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">normalizedRegret</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_lowerbound</span><span class="p">:</span>
                <span class="c1"># We also plot the Lai &amp; Robbins lower bound</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">lowerbound</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">X</span><span class="p">)[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;[Lai &amp; Robbins] lower bound = $</span><span class="si">{:.3g}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lowerbound</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="c1"># We also plot the Kwon et al lower bound</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">_sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lowerbound_sparse</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">lowerbound_sparse</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">X</span><span class="p">)[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;[Kwon et al.] lower bound, $s = </span><span class="si">{}</span><span class="s2">$, $= </span><span class="si">{:.3g}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">_sparsity</span><span class="p">,</span> <span class="n">lowerbound_sparse</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">legend</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_break_points</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># DONE fix math formula in case of non stationary bandits</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Normalized non-stationary regret\n$\frac</span><span class="si">{R_t}</span><span class="s2">{\log(t)} = \frac</span><span class="si">{1}</span><span class="s2">{\log(t)}\sum_{s=1}^</span><span class="si">{t}</span><span class="s2"> \max_k \mu_k(t) - \frac</span><span class="si">{1}</span><span class="s2">{\log(t)}$ </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\sum_{s=1}^</span><span class="si">{t}</span><span class="s2"> \sum_{k=1}^{</span><span class="si">%d</span><span class="s2">} \mu_k(t) \mathbb</span><span class="si">{E}</span><span class="s2">_{</span><span class="si">%d</span><span class="s2">}[1(I(t)=k)]$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="k">if</span> <span class="n">moreAccurate</span> <span class="k">else</span> <span class="sa">r</span><span class="s2">&quot;$\sum_{s=1}^</span><span class="si">{t}</span><span class="s2"> $\mathbb</span><span class="si">{E}</span><span class="s2">_{</span><span class="si">%d</span><span class="s2">}[r_s]$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">),</span> <span class="n">ylabel2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Normalized regret</span><span class="si">%s</span><span class="s2">$\frac</span><span class="si">{R_t}</span><span class="s2">{\log(t)} = \frac</span><span class="si">{t}</span><span class="s2">{\log(t)} \mu^* - \frac</span><span class="si">{1}</span><span class="s2">{\log(t)}\sum_{s=1}^</span><span class="si">{t}</span><span class="s2">$ </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\sum_{k=1}^{</span><span class="si">%d</span><span class="s2">} \mu_k\mathbb</span><span class="si">{E}</span><span class="s2">_{</span><span class="si">%d</span><span class="s2">}[T_k(t)]$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="k">if</span> <span class="n">moreAccurate</span> <span class="k">else</span> <span class="sa">r</span><span class="s2">&quot;$\mathbb</span><span class="si">{E}</span><span class="s2">_{</span><span class="si">%d</span><span class="s2">}[r_s]$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">),</span> <span class="n">ylabel2</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Normalized cumulated regrets for different bandit algorithms, averaged $</span><span class="si">{}</span><span class="s2">$ times</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">drawUpperBound</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">semilogx</span> <span class="ow">or</span> <span class="n">loglog</span><span class="p">):</span>
                <span class="c1"># Experiment to print also an upper bound: it is CRAZILY huge!!</span>
                <span class="n">lower_amplitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">arm</span><span class="o">.</span><span class="n">lower_amplitude</span> <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">arms</span><span class="p">])</span>
                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lower_amplitudes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">maxVariance</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">means</span><span class="p">])</span>
                <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span>
                <span class="n">upperbound</span> <span class="o">=</span> <span class="mi">76</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">maxVariance</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">K</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">upperbound</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Minimax upper-bound for kl-UCB++&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="c1"># FIXED for semilogx plots, truncate to only show t &gt;= 100</span>
            <span class="k">if</span> <span class="n">semilogx</span> <span class="ow">or</span> <span class="n">loglog</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_lowerbound</span><span class="p">:</span>
                <span class="c1"># We also plot the Lai &amp; Robbins lower bound</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">lowerbound</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">X</span><span class="p">)[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;[Lai &amp; Robbins] lower bound = $</span><span class="si">{:.3g}</span><span class="s2">\; \log(t)$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lowerbound</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="c1"># We also plot the Kwon et al lower bound</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">_sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lowerbound_sparse</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">lowerbound_sparse</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">X</span><span class="p">)[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;[Kwon et al.] lower bound, $s = </span><span class="si">{}</span><span class="s2">$, $= </span><span class="si">{:.3g}</span><span class="s2"> \; \log(t)$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">_sparsity</span><span class="p">,</span> <span class="n">lowerbound_sparse</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">legend</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_break_points</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># DONE fix math formula in case of non stationary bandits</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Non-stationary regret\n$R_t = \sum_{s=1}^</span><span class="si">{t}</span><span class="s2"> \max_k \mu_k(s) - \sum_{s=1}^</span><span class="si">{t}</span><span class="s2">$</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\sum_{k=1}^{</span><span class="si">%d</span><span class="s2">} \mu_k\mathbb</span><span class="si">{P}</span><span class="s2">_{</span><span class="si">%d</span><span class="s2">}[A(t)=k]$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="k">if</span> <span class="n">moreAccurate</span> <span class="k">else</span> <span class="sa">r</span><span class="s2">&quot;$\mathbb</span><span class="si">{E}</span><span class="s2">_{</span><span class="si">%d</span><span class="s2">}[r_s]$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">),</span> <span class="n">ylabel2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Regret $R_t = t \mu^* - \sum_{s=1}^</span><span class="si">{t}</span><span class="s2">$ </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\sum_{k=1}^{</span><span class="si">%d</span><span class="s2">} \mu_k\mathbb</span><span class="si">{E}</span><span class="s2">_{</span><span class="si">%d</span><span class="s2">}[T_k(t)]$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="k">if</span> <span class="n">moreAccurate</span> <span class="k">else</span> <span class="sa">r</span><span class="s2">&quot;$\mathbb</span><span class="si">{E}</span><span class="s2">_{</span><span class="si">%d</span><span class="s2">}[r_s]$ (from actual rewards)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">),</span> <span class="n">ylabel2</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cumulated regrets for different bandit algorithms, averaged $</span><span class="si">{}</span><span class="s2">$ times</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="n">show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showplot</span><span class="p">,</span> <span class="n">savefig</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">pickleit</span><span class="o">=</span><span class="n">USE_PICKLE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Evaluator.plotBestArmPulls"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.plotBestArmPulls">[docs]</a>    <span class="k">def</span> <span class="nf">plotBestArmPulls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the frequency of pulls of the best channel.</span>

<span class="sd">        - Warning: does not adapt to dynamic settings!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">palette</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">)</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="n">makemarkers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_times</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBestArmPulls</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">envId</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">lw</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;$N=&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="ow">or</span> <span class="s1">&#39;Aggr&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="ow">or</span> <span class="s1">&#39;CORRAL&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="ow">or</span> <span class="s1">&#39;LearnExp&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="ow">or</span> <span class="s1">&#39;Exp4&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">)</span> <span class="k">else</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span> <span class="n">lw</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">Y</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t_plot</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">markevery</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
        <span class="n">legend</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xlabel</span><span class="p">(</span><span class="n">envId</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;Time steps $t = 1...T$, horizon $T = </span><span class="si">{}</span><span class="s2">$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
        <span class="n">add_percent_formatter</span><span class="p">(</span><span class="s2">&quot;yaxis&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency of pulls of the optimal arm&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Best arm pulls frequency for different bandit algorithms, averaged $</span><span class="si">{}</span><span class="s2">$ times</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="n">show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showplot</span><span class="p">,</span> <span class="n">savefig</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">pickleit</span><span class="o">=</span><span class="n">USE_PICKLE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Evaluator.printRunningTimes"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.printRunningTimes">[docs]</a>    <span class="k">def</span> <span class="nf">printRunningTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the average+-std running time of the different policies.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Giving the mean and std running times ...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">IPython.core.magics.execution</span> <span class="k">import</span> <span class="n">_format_time</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">_format_time</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRunningTimes</span><span class="p">(</span><span class="n">envId</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">means</span><span class="p">):</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">For policy #</span><span class="si">{}</span><span class="s2"> called &#39;</span><span class="si">{}</span><span class="s2">&#39; ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">))</span>
            <span class="n">mean_time</span><span class="p">,</span> <span class="n">var_time</span>  <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="n">stds</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;    </span><span class="si">{}</span><span class="s2"> (mean of 1 run)&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_format_time</span><span class="p">(</span><span class="n">mean_time</span><span class="p">,</span> <span class="n">precision</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;    </span><span class="si">{}</span><span class="s2"> Â± </span><span class="si">{}</span><span class="s2"> per loop (mean Â± std. dev. of </span><span class="si">{}</span><span class="s2"> run)&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_format_time</span><span class="p">(</span><span class="n">mean_time</span><span class="p">,</span> <span class="n">precision</span><span class="p">),</span> <span class="n">_format_time</span><span class="p">(</span><span class="n">var_time</span><span class="p">,</span> <span class="n">precision</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For policy #</span><span class="si">{}</span><span class="s2"> called &#39;</span><span class="si">{}</span><span class="s2">&#39; ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">))</span>
            <span class="n">mean_time</span><span class="p">,</span> <span class="n">var_time</span>  <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="n">stds</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;T^{</span><span class="si">%i</span><span class="s2">}_{T=</span><span class="si">%i</span><span class="s2">,K=</span><span class="si">%i</span><span class="s2">} = &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">policyId</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> pm </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">mean_time</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">var_time</span><span class="p">))))</span>  <span class="c1"># XXX in milli seconds</span></div>
        <span class="c1"># table_to_latex(mean_data=means, std_data=stds, labels=[policy.__cachedstr__ for policy in self.policies], fmt_function=_format_time)</span>

<div class="viewcode-block" id="Evaluator.plotRunningTimes"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.plotRunningTimes">[docs]</a>    <span class="k">def</span> <span class="nf">plotRunningTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;seconds&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the running times of the different policies, as a box plot for each.&quot;&quot;&quot;</span>
        <span class="n">means</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">all_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRunningTimes</span><span class="p">(</span><span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">)</span>
        <span class="c1"># order by increasing mean time</span>
        <span class="n">index_of_sorting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_sorting</span> <span class="p">]</span>
        <span class="n">all_times</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_times</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_sorting</span> <span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">violin_or_box_plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">all_times</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">boxplot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_box_plot</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Bandit algorithms</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Running times (in </span><span class="si">{}</span><span class="s2">), for </span><span class="si">{}</span><span class="s2"> repetitions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">adjust_xticks_subplots</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Running times for different bandit algorithms, horizon $T=</span><span class="si">{}</span><span class="s2">$, averaged $</span><span class="si">{}</span><span class="s2">$ times</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="n">show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showplot</span><span class="p">,</span> <span class="n">savefig</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">pickleit</span><span class="o">=</span><span class="n">USE_PICKLE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Evaluator.printMemoryConsumption"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.printMemoryConsumption">[docs]</a>    <span class="k">def</span> <span class="nf">printMemoryConsumption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the average+-std memory consumption of the different policies.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Giving the mean and std memory consumption ...&quot;</span><span class="p">)</span>
        <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMemoryConsumption</span><span class="p">(</span><span class="n">envId</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">means</span><span class="p">):</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">For policy #</span><span class="si">{}</span><span class="s2"> called &#39;</span><span class="si">{}</span><span class="s2">&#39; ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">))</span>
            <span class="n">mean_memory</span><span class="p">,</span> <span class="n">var_memory</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="n">stds</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;    </span><span class="si">{}</span><span class="s2"> (mean of 1 run)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sizeof_fmt</span><span class="p">(</span><span class="n">mean_memory</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;    </span><span class="si">{}</span><span class="s2"> Â± </span><span class="si">{}</span><span class="s2"> (mean Â± std. dev. of </span><span class="si">{}</span><span class="s2"> runs)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sizeof_fmt</span><span class="p">(</span><span class="n">mean_memory</span><span class="p">),</span> <span class="n">sizeof_fmt</span><span class="p">(</span><span class="n">var_memory</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For policy #</span><span class="si">{}</span><span class="s2"> called &#39;</span><span class="si">{}</span><span class="s2">&#39; ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">))</span>
            <span class="n">mean_memory</span><span class="p">,</span> <span class="n">var_memory</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="n">stds</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;M^{</span><span class="si">%i</span><span class="s2">}_{T=</span><span class="si">%i</span><span class="s2">,K=</span><span class="si">%i</span><span class="s2">} = &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">policyId</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> pm </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">mean_memory</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">var_memory</span><span class="p">))))</span>  <span class="c1"># XXX in B</span></div>
        <span class="c1"># table_to_latex(mean_data=means, std_data=stds, labels=[policy.__cachedstr__ for policy in self.policies], fmt_function=sizeof_fmt)</span>

<div class="viewcode-block" id="Evaluator.plotMemoryConsumption"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.plotMemoryConsumption">[docs]</a>    <span class="k">def</span> <span class="nf">plotMemoryConsumption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;KiB&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the memory consumption of the different policies, as a box plot for each.&quot;&quot;&quot;</span>
        <span class="n">means</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">all_memories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMemoryConsumption</span><span class="p">(</span><span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">)</span>
        <span class="c1"># order by increasing mean memory consumption</span>
        <span class="n">index_of_sorting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_sorting</span> <span class="p">]</span>
        <span class="n">all_memories</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_memories</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_sorting</span> <span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">violin_or_box_plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">all_memories</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">boxplot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Bandit algorithms</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Memory consumption (in </span><span class="si">{}</span><span class="s2">), for </span><span class="si">{}</span><span class="s2"> repetitions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">adjust_xticks_subplots</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Memory consumption for different bandit algorithms, horizon $T=</span><span class="si">{}</span><span class="s2">$, averaged $</span><span class="si">{}</span><span class="s2">$ times</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="n">show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showplot</span><span class="p">,</span> <span class="n">savefig</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">pickleit</span><span class="o">=</span><span class="n">USE_PICKLE</span><span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.printNumberOfCPDetections"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.printNumberOfCPDetections">[docs]</a>    <span class="k">def</span> <span class="nf">printNumberOfCPDetections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the average+-std number_of_cp_detections of the different policies.&quot;&quot;&quot;</span>
        <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfCPDetections</span><span class="p">(</span><span class="n">envId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">means</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Giving the mean and std number of CP detections ...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">means</span><span class="p">):</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">For policy #</span><span class="si">{}</span><span class="s2"> called &#39;</span><span class="si">{}</span><span class="s2">&#39; ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">))</span>
            <span class="n">mean_number_of_cp_detections</span><span class="p">,</span> <span class="n">var_number_of_cp_detections</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="n">stds</span><span class="p">[</span><span class="n">policyId</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;    </span><span class="si">{:.3g}</span><span class="s2"> (mean of 1 run)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean_number_of_cp_detections</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;    </span><span class="si">{:.3g}</span><span class="s2"> Â± </span><span class="si">{:.3g}</span><span class="s2"> (mean Â± std. dev. of </span><span class="si">{}</span><span class="s2"> runs)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean_number_of_cp_detections</span><span class="p">,</span> <span class="n">var_number_of_cp_detections</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span></div>
        <span class="c1"># table_to_latex(mean_data=means, std_data=stds, labels=[policy.__cachedstr__ for policy in self.policies])</span>

<div class="viewcode-block" id="Evaluator.plotNumberOfCPDetections"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.plotNumberOfCPDetections">[docs]</a>    <span class="k">def</span> <span class="nf">plotNumberOfCPDetections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the number of change-point detections of the different policies, as a box plot for each.&quot;&quot;&quot;</span>
        <span class="n">means</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">all_number_of_cp_detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfCPDetections</span><span class="p">(</span><span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">means</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># order by increasing mean nb of change-point detection</span>
        <span class="n">index_of_sorting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_sorting</span> <span class="p">]</span>
        <span class="n">all_number_of_cp_detections</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_number_of_cp_detections</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_sorting</span> <span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">violin_or_box_plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">all_number_of_cp_detections</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">boxplot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Bandit algorithms</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Number of detected change-points, for </span><span class="si">{}</span><span class="s2"> repetitions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">adjust_xticks_subplots</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Detected change-points for different bandit algorithms, horizon $T=</span><span class="si">{}</span><span class="s2">$, averaged $</span><span class="si">{}</span><span class="s2">$ times</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="n">show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showplot</span><span class="p">,</span> <span class="n">savefig</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">pickleit</span><span class="o">=</span><span class="n">USE_PICKLE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Evaluator.printLastRegrets"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.printLastRegrets">[docs]</a>    <span class="k">def</span> <span class="nf">printLastRegrets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the last regrets of the different policies.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Giving the vector of final regrets ...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  For policy #</span><span class="si">{}</span><span class="s2"> called &#39;</span><span class="si">{}</span><span class="s2">&#39; ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">))</span>
            <span class="n">last_regrets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastRegrets</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="n">moreAccurate</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Last regrets (for all repetitions) have:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Min of    last regrets R_T = </span><span class="si">{:.3g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">last_regrets</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean of   last regrets R_T = </span><span class="si">{:.3g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">last_regrets</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Median of last regrets R_T = </span><span class="si">{:.3g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">last_regrets</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max of    last regrets R_T = </span><span class="si">{:.3g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">last_regrets</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Standard deviation     R_T = </span><span class="si">{:.3g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">last_regrets</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For policy #</span><span class="si">{}</span><span class="s2"> called &#39;</span><span class="si">{}</span><span class="s2">&#39; ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">))</span>
            <span class="n">last_regrets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastRegrets</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="n">moreAccurate</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;R^{</span><span class="si">%i</span><span class="s2">}_{T=</span><span class="si">%i</span><span class="s2">,K=</span><span class="si">%i</span><span class="s2">} = &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">policyId</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> pm </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">last_regrets</span><span class="p">))),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">last_regrets</span><span class="p">)))))</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLastRegrets</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="n">moreAccurate</span><span class="p">))</span> <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">)]</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLastRegrets</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="n">moreAccurate</span><span class="p">))</span> <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">)]</span></div>
        <span class="c1"># table_to_latex(mean_data=means, std_data=stds, labels=[policy.__cachedstr__ for policy in self.policies])</span>

<div class="viewcode-block" id="Evaluator.plotLastRegrets"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.plotLastRegrets">[docs]</a>    <span class="k">def</span> <span class="nf">plotLastRegrets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">normed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbbins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">all_on_separate_figures</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">boxplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalized_boxplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot histogram of the regrets R_T for all policies.&quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">subplots</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># no need for a subplot</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">palette</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="n">makemarkers</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">boxplot</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">boxplot</span><span class="p">:</span>
            <span class="n">all_last_regrets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
                <span class="n">last_regret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastRegrets</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="n">moreAccurate</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">normalized_boxplot</span><span class="p">:</span>
                    <span class="n">last_regret</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span>
                <span class="n">all_last_regrets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_regret</span><span class="p">)</span>
            <span class="n">means</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">last_regrets</span><span class="p">)</span> <span class="k">for</span> <span class="n">last_regrets</span> <span class="ow">in</span> <span class="n">all_last_regrets</span> <span class="p">]</span>
            <span class="c1"># order by increasing mean regret</span>
            <span class="n">index_of_sorting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span> <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_sorting</span> <span class="p">]</span>
            <span class="n">all_last_regrets</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_last_regrets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_sorting</span> <span class="p">]</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Bandit algorithms</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">egret value $R_T</span><span class="si">{}</span><span class="s2">$,</span><span class="se">\n</span><span class="s2">for $T = </span><span class="si">{}</span><span class="s2">$, for </span><span class="si">{}</span><span class="s2"> repetitions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Normalized r&quot;</span> <span class="k">if</span> <span class="n">normalized_boxplot</span> <span class="k">else</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;/\log(T)&quot;</span> <span class="k">if</span> <span class="n">normalized_boxplot</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">)</span>
            <span class="n">violin_or_box_plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">all_last_regrets</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">boxplot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_box_plot</span><span class="p">)</span>
            <span class="n">adjust_xticks_subplots</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Regret for different bandit algorithms, horizon $T=</span><span class="si">{}</span><span class="s2">$, averaged $</span><span class="si">{}</span><span class="s2">$ times</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">all_on_separate_figures</span><span class="p">:</span>
            <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of regrets for </span><span class="si">{}</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Regret value $R_T$, horizon $T = </span><span class="si">{}</span><span class="s2">$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> of observations, $</span><span class="si">{}</span><span class="s2">$ repetitions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span> <span class="k">if</span> <span class="n">normed</span> <span class="k">else</span> <span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span>
                <span class="n">last_regrets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastRegrets</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="n">moreAccurate</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">last_regrets</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbbins</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="n">kde_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cut&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="n">markers</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="s1">&#39;markevery&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">policyId</span> <span class="o">/</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)})</span>
                <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: a call to sns.distplot() failed because of a stupid numpy.linalg.linalg.LinAlgError exception... See https://api.travis-ci.org/v3/job/528931259/log.txt&quot;</span><span class="p">)</span>  <span class="c1"># WARNING</span>
                <span class="n">legend</span><span class="p">()</span>
                <span class="n">show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showplot</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">savefig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">__Algo_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">savefig</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">policyId</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">N</span><span class="p">),</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">pickleit</span><span class="o">=</span><span class="n">USE_PICKLE</span><span class="p">)</span>
                <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">figs</span>
        <span class="k">elif</span> <span class="n">subplots</span><span class="p">:</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">nrows_ncols</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Histogram of regrets for different bandit algorithms</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
            <span class="c1"># XXX See https://stackoverflow.com/a/36542971/</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">frame_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># add a big axes, hide frame</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># hide grid</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># hide tick and tick label of the big axes</span>
            <span class="c1"># Add only once the ylabel, xlabel, in the middle</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> of observations, $</span><span class="si">{}</span><span class="s2">$ repetitions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span> <span class="k">if</span> <span class="n">normed</span> <span class="k">else</span> <span class="s2">&quot;Histogram and density&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Regret value $R_T$, horizon $T = </span><span class="si">{}</span><span class="s2">$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">policyId</span> <span class="o">%</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">policyId</span> <span class="o">//</span> <span class="n">nrows</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">ncols</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">last_regrets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastRegrets</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="n">moreAccurate</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">last_regrets</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbbins</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="n">kde_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cut&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="n">markers</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="s1">&#39;markevery&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">policyId</span> <span class="o">/</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)})</span>  <span class="c1"># XXX</span>
                <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: a call to sns.distplot() failed because of a stupid numpy.linalg.linalg.LinAlgError exception... See https://api.travis-ci.org/v3/job/528931259/log.txt&quot;</span><span class="p">)</span>  <span class="c1"># WARNING</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;xx-small&#39;</span><span class="p">})</span>  <span class="c1"># XXX one of x-large, medium, small, None, xx-large, x-small, xx-small, smaller, larger, large</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>  <span class="c1"># XXX https://stackoverflow.com/a/11386056/</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of regrets for different bandit algorithms</span><span class="se">\n</span><span class="s2">$</span><span class="si">{}</span><span class="s2">$ arms</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">str_sparsity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span><span class="o">.</span><span class="n">reprarms</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Regret value $R_T$, horizon $T = </span><span class="si">{}</span><span class="s2">$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> of observations, $</span><span class="si">{}</span><span class="s2">$ repetitions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span> <span class="k">if</span> <span class="n">normed</span> <span class="k">else</span> <span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span><span class="p">))</span>
            <span class="n">all_last_regrets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">policyId</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
                <span class="n">all_last_regrets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLastRegrets</span><span class="p">(</span><span class="n">policyId</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="n">envId</span><span class="p">,</span> <span class="n">moreAccurate</span><span class="o">=</span><span class="n">moreAccurate</span><span class="p">))</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">__cachedstr__</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span> <span class="n">nbbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbbins</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">policyId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbPolicies</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">all_last_regrets</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="n">hist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="n">kde_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cut&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="n">markers</span><span class="p">[</span><span class="n">policyId</span><span class="p">],</span> <span class="s1">&#39;markevery&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">policyId</span> <span class="o">/</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)})</span>  <span class="c1">#, bins=nbbins)  # XXX</span>
                <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: a call to sns.distplot() failed because of a stupid numpy.linalg.linalg.LinAlgError exception... See https://api.travis-ci.org/v3/job/528931259/log.txt&quot;</span><span class="p">)</span>  <span class="c1"># WARNING</span>
            <span class="n">legend</span><span class="p">()</span>
        <span class="c1"># Common part</span>
        <span class="n">show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showplot</span><span class="p">,</span> <span class="n">savefig</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">pickleit</span><span class="o">=</span><span class="n">USE_PICKLE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Evaluator.plotHistoryOfMeans"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.Evaluator.plotHistoryOfMeans">[docs]</a>    <span class="k">def</span> <span class="nf">plotHistoryOfMeans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the history of means, as a plot with x axis being the time, y axis the mean rewards, and K curves one for each arm.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">horizon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">horizon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">[</span><span class="n">envId</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;plotHistoryOfMeans&#39;</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">plotHistoryOfMeans</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="n">horizon</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="n">savefig</span><span class="p">,</span> <span class="n">showplot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showplot</span><span class="p">)</span>
            <span class="c1"># FIXME https://github.com/SMPyBandits/SMPyBandits/issues/175#issuecomment-455637453</span>
            <span class="c1">#  For one trajectory, we can ask Evaluator.Evaluator to store not only the number of detections, but more! We can store the times of detections, for each arms (as a list of list).</span>
            <span class="c1"># If we have these data (for each repetitions), we can plot the detection times (for each arm) on a plot like the following</span>
            <span class="k">return</span> <span class="n">fig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: environment </span><span class="si">{}</span><span class="s2"> did not have a method plotHistoryOfMeans...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env</span><span class="p">))</span>  <span class="c1"># DEBUG</span></div></div>


<span class="c1"># Helper function for the parallelization</span>

<div class="viewcode-block" id="delayed_play"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.delayed_play">[docs]</a><span class="k">def</span> <span class="nf">delayed_play</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span>
                    <span class="n">random_shuffle</span><span class="o">=</span><span class="n">random_shuffle</span><span class="p">,</span> <span class="n">random_invert</span><span class="o">=</span><span class="n">random_invert</span><span class="p">,</span> <span class="n">nb_break_points</span><span class="o">=</span><span class="n">nb_break_points</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allrewards</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repeatId</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">useJoblib</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function for the parallelization.&quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">start_memory</span> <span class="o">=</span> <span class="n">getCurrentMemory</span><span class="p">(</span><span class="n">thread</span><span class="o">=</span><span class="n">useJoblib</span><span class="p">)</span>
    <span class="c1"># Give a unique seed to random &amp; numpy.random for each call of this function</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="c1"># We have to deepcopy because this function is Parallel-ized</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">means</span>
    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">isChangingAtEachRepetition</span><span class="p">:</span>
        <span class="n">means</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">newRandomArms</span><span class="p">()</span>
    <span class="n">indexes_bestarm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">means</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Start game</span>
    <span class="n">policy</span><span class="o">.</span><span class="n">startGame</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">nbArms</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">indexes_bestarm</span><span class="o">=</span><span class="n">indexes_bestarm</span><span class="p">,</span> <span class="n">means</span><span class="o">=</span><span class="n">means</span><span class="p">)</span>  <span class="c1"># One Result object, for every policy</span>

    <span class="c1"># FIXME Monkey patching policy.detect_change() to store number of detections, see https://stackoverflow.com/a/42657312/</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="s1">&#39;detect_change&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">MethodType</span>
        <span class="n">old_detect_change</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">detect_change</span>
        <span class="k">def</span> <span class="nf">new_detect_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">did_it_detect_a_change</span> <span class="o">=</span> <span class="n">old_detect_change</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">did_it_detect_a_change</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">number_of_cp_detections</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">did_it_detect_a_change</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">detect_change</span> <span class="o">=</span> <span class="n">MethodType</span><span class="p">(</span><span class="n">new_detect_change</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>

    <span class="c1"># XXX Experimental support for random events: shuffling or inverting the list of arms, at these time steps</span>
    <span class="k">if</span> <span class="n">nb_break_points</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nb_break_points</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">random_shuffle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">random_invert</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">nb_break_points</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">horizon</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nb_break_points</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_break_points</span><span class="p">)]</span>

    <span class="n">prettyRange</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">horizon</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Time t&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">repeatId</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">prettyRange</span><span class="p">:</span>
        <span class="c1"># 1. The player&#39;s policy choose an arm</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">choice</span><span class="p">()</span>

        <span class="c1"># 2. A random reward is drawn, from this arm at this time</span>
        <span class="k">if</span> <span class="n">allrewards</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="n">allrewards</span><span class="p">[</span><span class="n">choice</span><span class="p">,</span> <span class="n">repeatId</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>

        <span class="c1"># 3. The policy sees the reward</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">getReward</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span>

        <span class="c1"># 4. Finally we store the results</span>
        <span class="n">result</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">choice</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">isDynamic</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">changePoints</span><span class="p">:</span>
                <span class="n">means</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">newRandomArms</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">indexes_bestarm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">means</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">result</span><span class="o">.</span><span class="n">change_in_arms</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">indexes_bestarm</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">repeatId</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">New means vector = </span><span class="si">{}</span><span class="s2">, best arm(s) = </span><span class="si">{}</span><span class="s2">, at time t = </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">indexes_bestarm</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>  <span class="c1"># DEBUG</span>

        <span class="c1"># XXX remove these two special cases when the NonStationaryMAB is ready?</span>
        <span class="c1"># XXX regret is not correct when displayed for these two guysâ€¦</span>
        <span class="c1"># XXX Experimental : shuffle the arms at the middle of the simulation</span>
        <span class="k">if</span> <span class="n">random_shuffle</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_events</span><span class="p">:</span>
                <span class="n">indexes_bestarm</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">new_order_of_arm</span><span class="p">(</span><span class="n">shuffled</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">arms</span><span class="p">))</span>
                <span class="n">result</span><span class="o">.</span><span class="n">change_in_arms</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">indexes_bestarm</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">repeatId</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Shuffling the arms, best arm(s) = </span><span class="si">{}</span><span class="s2">, at time t = </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indexes_bestarm</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>  <span class="c1"># DEBUG</span>
        <span class="c1"># XXX Experimental : invert the order of the arms at the middle of the simulation</span>
        <span class="k">if</span> <span class="n">random_invert</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_events</span><span class="p">:</span>
                <span class="n">indexes_bestarm</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">new_order_of_arm</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">arms</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">result</span><span class="o">.</span><span class="n">change_in_arms</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">indexes_bestarm</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">repeatId</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Inverting the order of the arms, best arm(s) = </span><span class="si">{}</span><span class="s2">, at time t = </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indexes_bestarm</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>  <span class="c1"># DEBUG</span>

    <span class="c1"># Print the quality of estimation of arm ranking for this policy, just for 1st repetition</span>
    <span class="k">if</span> <span class="n">repeatId</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="s1">&#39;estimatedOrder&#39;</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">estimatedOrder</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Estimated order by the policy </span><span class="si">{}</span><span class="s2"> after </span><span class="si">{}</span><span class="s2"> steps: </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ==&gt; Optimal arm identification: </span><span class="si">{:.2%}</span><span class="s2"> (relative success)...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weightedDistance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">means</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
        <span class="c1"># print(&quot;  ==&gt; Manhattan   distance from optimal ordering: {:.2%} (relative success)...&quot;.format(manhattan(order)))</span>
        <span class="c1"># # print(&quot;  ==&gt; Kendell Tau distance from optimal ordering: {:.2%} (relative success)...&quot;.format(kendalltau(order)))</span>
        <span class="c1"># # print(&quot;  ==&gt; Spearman    distance from optimal ordering: {:.2%} (relative success)...&quot;.format(spearmanr(order)))</span>
        <span class="c1"># print(&quot;  ==&gt; Gestalt     distance from optimal ordering: {:.2%} (relative success)...&quot;.format(gestalt(order)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ==&gt; Mean distance from optimal ordering: </span><span class="si">{:.2%}</span><span class="s2"> (relative success)...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanDistance</span><span class="p">(</span><span class="n">order</span><span class="p">)))</span>

    <span class="c1"># Finally, store running time and consumed memory</span>
    <span class="n">result</span><span class="o">.</span><span class="n">running_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="n">memory_consumption</span> <span class="o">=</span> <span class="n">getCurrentMemory</span><span class="p">(</span><span class="n">thread</span><span class="o">=</span><span class="n">useJoblib</span><span class="p">)</span> <span class="o">-</span> <span class="n">start_memory</span>
    <span class="k">if</span> <span class="n">memory_consumption</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># XXX https://stackoverflow.com/a/565382/</span>
        <span class="n">memory_consumption</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">policy</span><span class="p">))</span>
        <span class="c1"># if repeatId == 0: print(&quot;Warning: unable to get the memory consumption for policy {}, so we used a trick to measure {} bytes.&quot;.format(policy, memory_consumption))  # DEBUG</span>
    <span class="n">result</span><span class="o">.</span><span class="n">memory_consumption</span> <span class="o">=</span> <span class="n">memory_consumption</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="c1"># --- Helper for loading a previous Evaluator object</span>

<div class="viewcode-block" id="EvaluatorFromDisk"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.EvaluatorFromDisk">[docs]</a><span class="k">def</span> <span class="nf">EvaluatorFromDisk</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="s1">&#39;/tmp/saveondiskEvaluator.hdf5&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create a new Evaluator object from the HDF5 file given in argument.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdf</span><span class="p">:</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="n">hdf</span><span class="o">.</span><span class="n">configuration</span>
        <span class="n">evaluator</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="n">evaluator</span><span class="o">.</span><span class="n">loadfromdisk</span><span class="p">(</span><span class="n">hdf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">evaluator</span></div>


<span class="c1"># --- Utility function</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>


<div class="viewcode-block" id="shuffled"><a class="viewcode-back" href="../../docs/Environment.Evaluator.html#Environment.Evaluator.shuffled">[docs]</a><span class="k">def</span> <span class="nf">shuffled</span><span class="p">(</span><span class="n">mylist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a shuffled version of the input 1D list. sorted() exists instead of list.sort(), but shuffled() does not exist instead of random.shuffle()...</span>

<span class="sd">    &gt;&gt;&gt; from random import seed; seed(1234)  # reproducible results</span>
<span class="sd">    &gt;&gt;&gt; mylist = [ 0.1,  0.2,  0.3,  0.4,  0.5,  0.6,  0.7,  0.8,  0.9]</span>
<span class="sd">    &gt;&gt;&gt; shuffled(mylist)</span>
<span class="sd">    [0.9, 0.4, 0.3, 0.6, 0.5, 0.7, 0.1, 0.2, 0.8]</span>
<span class="sd">    &gt;&gt;&gt; shuffled(mylist)</span>
<span class="sd">    [0.4, 0.3, 0.7, 0.5, 0.8, 0.1, 0.9, 0.6, 0.2]</span>
<span class="sd">    &gt;&gt;&gt; shuffled(mylist)</span>
<span class="sd">    [0.4, 0.6, 0.9, 0.5, 0.7, 0.2, 0.1, 0.3, 0.8]</span>
<span class="sd">    &gt;&gt;&gt; shuffled(mylist)</span>
<span class="sd">    [0.8, 0.7, 0.3, 0.1, 0.9, 0.5, 0.6, 0.2, 0.4]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">copiedlist</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">copiedlist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">copiedlist</span></div>


<span class="c1"># --- Debugging</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Code for debugging purposes.</span>
    <span class="kn">from</span> <span class="nn">doctest</span> <span class="k">import</span> <span class="n">testmod</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Testing automatically all the docstring written in each functions of this module :&quot;</span><span class="p">)</span>
    <span class="n">testmod</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2018, Lilian Besson (Naereen)
      <span class="lastupdated">
        Last updated on 09 May 2019, 19h.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>