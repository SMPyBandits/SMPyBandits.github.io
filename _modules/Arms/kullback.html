

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38514290-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Arms.kullback &mdash; SMPyBandits 0.9.5 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> SMPyBandits
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html"><em>SMPyBandits</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/modules.html">SMPyBandits modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../How_to_run_the_code.html">How to run the code ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PublicationsWithSMPyBandits.html">List of research publications using Lilian Bessonâ€™s SMPyBandits project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Aggregation.html"><strong>Policy aggregation algorithms</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MultiPlayers.html"><strong>Multi-players simulation environment</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DoublingTrick.html"><strong>Doubling Trick for Multi-Armed Bandits</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SparseBandits.html"><strong>Structure and Sparsity of Stochastic Multi-Armed Bandits</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NonStationaryBandits.html"><strong>Non-Stationary Stochastic Multi-Armed Bandits</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../API.html">Short documentation of the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO.html">ðŸ’¥ TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots/README.html">Some illustrations for this project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/README.html">Jupyter Notebooks ðŸ““ by Naereen &#64; GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/list.html">List of notebooks for SMPyBandits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Profiling.html">A note on execution times, speed and profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uml_diagrams/README.html">UML diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logs/README.html"><code class="docutils literal notranslate"><span class="pre">logs</span></code> files</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SMPyBandits</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../Arms.html">Arms</a> &raquo;</li>
        
      <li>Arms.kullback</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Arms.kullback</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; Kullback-Leibler divergence functions and klUCB utilities.</span>

<span class="sd">- Faster implementation can be found in a C file, in ``Policies/C``, and should be compiled to speedup computations.</span>
<span class="sd">- However, the version here have examples, doctests, and are jit compiled on the fly (with numba, cf. http://numba.pydata.org/).</span>
<span class="sd">- Cf. https://en.wikipedia.org/wiki/Kullback%E2%80%93Leibler_divergence</span>
<span class="sd">- Reference: [Filippi, CappÃ© &amp; Garivier - Allerton, 2011](https://arxiv.org/pdf/1004.5229.pdf) and [Garivier &amp; CappÃ©, 2011](https://arxiv.org/pdf/1102.2490.pdf)</span>


<span class="sd">.. warning::</span>

<span class="sd">    All functions are *not* vectorized, and assume only one value for each argument.</span>
<span class="sd">    If you want vectorized function, use the wrapper :py:class:`numpy.vectorize`:</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; klBern_vect = np.vectorize(klBern)</span>
<span class="sd">    &gt;&gt;&gt; klBern_vect([0.1, 0.5, 0.9], 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    array([0.036..., 0.223..., 1.145...])</span>
<span class="sd">    &gt;&gt;&gt; klBern_vect(0.4, [0.2, 0.3, 0.4])  # doctest: +ELLIPSIS</span>
<span class="sd">    array([0.104..., 0.022..., 0...])</span>
<span class="sd">    &gt;&gt;&gt; klBern_vect([0.1, 0.5, 0.9], [0.2, 0.3, 0.4])  # doctest: +ELLIPSIS</span>
<span class="sd">    array([0.036..., 0.087..., 0.550...])</span>

<span class="sd">    For some functions, you would be better off writing a vectorized version manually, for instance if you want to fix a value of some optional parameters:</span>

<span class="sd">    &gt;&gt;&gt; # WARNING using np.vectorize gave weird result on klGauss</span>
<span class="sd">    &gt;&gt;&gt; # klGauss_vect = np.vectorize(klGauss, excluded=&quot;y&quot;)</span>
<span class="sd">    &gt;&gt;&gt; def klGauss_vect(xs, y, sig2x=0.25):  # vectorized for first input only</span>
<span class="sd">    ...    return np.array([klGauss(x, y, sig2x) for x in xs])</span>
<span class="sd">    &gt;&gt;&gt; klGauss_vect([-1, 0, 1], 0.1)  # doctest: +ELLIPSIS</span>
<span class="sd">    array([2.42, 0.02, 1.62])</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>  <span class="c1"># Python 2 compatibility</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Olivier CappÃ©, AurÃ©lien Garivier, Lilian Besson&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.9&quot;</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">exp</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># https://www.docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.fixed_point</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.usenumba</span> <span class="k">import</span> <span class="n">jit</span>  <span class="c1"># Import numba.jit or a dummy jit(f)=f</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="ne">SystemError</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">usenumba</span> <span class="k">import</span> <span class="n">jit</span>  <span class="c1"># Import numba.jit or a dummy jit(f)=f</span>


<span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-15</span>  <span class="c1">#: Threshold value: everything in [0, 1] is truncated to [eps, 1 - eps]</span>


<span class="c1"># --- Simple Kullback-Leibler divergence for known distributions</span>


<div class="viewcode-block" id="klBern"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klBern">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klBern</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Kullback-Leibler divergence for Bernoulli distributions. https://en.wikipedia.org/wiki/Bernoulli_distribution#Kullback.E2.80.93Leibler_divergence</span>

<span class="sd">    .. math:: \mathrm{KL}(\mathcal{B}(x), \mathcal{B}(y)) = x \log(\frac{x}{y}) + (1-x) \log(\frac{1-x}{1-y}).</span>

<span class="sd">    &gt;&gt;&gt; klBern(0.5, 0.5)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; klBern(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.757779...</span>
<span class="sd">    &gt;&gt;&gt; klBern(0.9, 0.1)  # And this KL is symmetric  # doctest: +ELLIPSIS</span>
<span class="sd">    1.757779...</span>
<span class="sd">    &gt;&gt;&gt; klBern(0.4, 0.5)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.020135...</span>
<span class="sd">    &gt;&gt;&gt; klBern(0.01, 0.99)  # doctest: +ELLIPSIS</span>
<span class="sd">    4.503217...</span>

<span class="sd">    - Special values:</span>

<span class="sd">    &gt;&gt;&gt; klBern(0, 1)  # Should be +inf, but 0 --&gt; eps, 1 --&gt; 1 - eps  # doctest: +ELLIPSIS</span>
<span class="sd">    34.539575...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">eps</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">))</span></div>


<div class="viewcode-block" id="klBin"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klBin">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klBin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Kullback-Leibler divergence for Binomial distributions. https://math.stackexchange.com/questions/320399/kullback-leibner-divergence-of-binomial-distributions</span>

<span class="sd">    - It is simply the n times :func:`klBern` on x and y.</span>

<span class="sd">    .. math:: \mathrm{KL}(\mathrm{Bin}(x, n), \mathrm{Bin}(y, n)) = n \times \left(x \log(\frac{x}{y}) + (1-x) \log(\frac{1-x}{1-y}) \right).</span>

<span class="sd">    .. warning:: The two distributions must have the same parameter n, and x, y are p, q in (0, 1).</span>

<span class="sd">    &gt;&gt;&gt; klBin(0.5, 0.5, 10)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; klBin(0.1, 0.9, 10)  # doctest: +ELLIPSIS</span>
<span class="sd">    17.57779...</span>
<span class="sd">    &gt;&gt;&gt; klBin(0.9, 0.1, 10)  # And this KL is symmetric  # doctest: +ELLIPSIS</span>
<span class="sd">    17.57779...</span>
<span class="sd">    &gt;&gt;&gt; klBin(0.4, 0.5, 10)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.20135...</span>
<span class="sd">    &gt;&gt;&gt; klBin(0.01, 0.99, 10)  # doctest: +ELLIPSIS</span>
<span class="sd">    45.03217...</span>

<span class="sd">    - Special values:</span>

<span class="sd">    &gt;&gt;&gt; klBin(0, 1, 10)  # Should be +inf, but 0 --&gt; eps, 1 --&gt; 1 - eps  # doctest: +ELLIPSIS</span>
<span class="sd">    345.39575...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">eps</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">)))</span></div>


<div class="viewcode-block" id="klPoisson"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klPoisson">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klPoisson</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Kullback-Leibler divergence for Poison distributions. https://en.wikipedia.org/wiki/Poisson_distribution#Kullback.E2.80.93Leibler_divergence</span>

<span class="sd">    .. math:: \mathrm{KL}(\mathrm{Poisson}(x), \mathrm{Poisson}(y)) = y - x + x \times \log(\frac{x}{y}).</span>

<span class="sd">    &gt;&gt;&gt; klPoisson(3, 3)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; klPoisson(2, 1)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.386294...</span>
<span class="sd">    &gt;&gt;&gt; klPoisson(1, 2)  # And this KL is non-symmetric  # doctest: +ELLIPSIS</span>
<span class="sd">    0.306852...</span>
<span class="sd">    &gt;&gt;&gt; klPoisson(3, 6)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.920558...</span>
<span class="sd">    &gt;&gt;&gt; klPoisson(6, 8)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.273907...</span>

<span class="sd">    - Special values:</span>

<span class="sd">    &gt;&gt;&gt; klPoisson(1, 0)  # Should be +inf, but 0 --&gt; eps, 1 --&gt; 1 - eps  # doctest: +ELLIPSIS</span>
<span class="sd">    33.538776...</span>
<span class="sd">    &gt;&gt;&gt; klPoisson(0, 0)</span>
<span class="sd">    0.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="klExp"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klExp">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klExp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Kullback-Leibler divergence for exponential distributions. https://en.wikipedia.org/wiki/Exponential_distribution#Kullback.E2.80.93Leibler_divergence</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathrm{KL}(\mathrm{Exp}(x), \mathrm{Exp}(y)) = \begin{cases}</span>
<span class="sd">        \frac{x}{y} - 1 - \log(\frac{x}{y}) &amp; \text{if} x &gt; 0, y &gt; 0\\</span>
<span class="sd">        +\infty &amp; \text{otherwise}</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    &gt;&gt;&gt; klExp(3, 3)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; klExp(3, 6)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.193147...</span>
<span class="sd">    &gt;&gt;&gt; klExp(1, 2)  # Only the proportion between x and y is used  # doctest: +ELLIPSIS</span>
<span class="sd">    0.193147...</span>
<span class="sd">    &gt;&gt;&gt; klExp(2, 1)  # And this KL is non-symmetric  # doctest: +ELLIPSIS</span>
<span class="sd">    0.306852...</span>
<span class="sd">    &gt;&gt;&gt; klExp(4, 2)  # Only the proportion between x and y is used  # doctest: +ELLIPSIS</span>
<span class="sd">    0.306852...</span>
<span class="sd">    &gt;&gt;&gt; klExp(6, 8)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.037682...</span>

<span class="sd">    - x, y have to be positive:</span>

<span class="sd">    &gt;&gt;&gt; klExp(-3, 2)</span>
<span class="sd">    inf</span>
<span class="sd">    &gt;&gt;&gt; klExp(3, -2)</span>
<span class="sd">    inf</span>
<span class="sd">    &gt;&gt;&gt; klExp(-3, -2)</span>
<span class="sd">    inf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;+inf&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="klGamma"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klGamma">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klGamma</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Kullback-Leibler divergence for gamma distributions. https://en.wikipedia.org/wiki/Gamma_distribution#Kullback.E2.80.93Leibler_divergence</span>

<span class="sd">    - It is simply the a times :func:`klExp` on x and y.</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathrm{KL}(\Gamma(x, a), \Gamma(y, a)) = \begin{cases}</span>
<span class="sd">        a \times \left( \frac{x}{y} - 1 - \log(\frac{x}{y}) \right) &amp; \text{if} x &gt; 0, y &gt; 0\\</span>
<span class="sd">        +\infty &amp; \text{otherwise}</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    .. warning:: The two distributions must have the same parameter a.</span>

<span class="sd">    &gt;&gt;&gt; klGamma(3, 3)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; klGamma(3, 6)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.193147...</span>
<span class="sd">    &gt;&gt;&gt; klGamma(1, 2)  # Only the proportion between x and y is used  # doctest: +ELLIPSIS</span>
<span class="sd">    0.193147...</span>
<span class="sd">    &gt;&gt;&gt; klGamma(2, 1)  # And this KL is non-symmetric  # doctest: +ELLIPSIS</span>
<span class="sd">    0.306852...</span>
<span class="sd">    &gt;&gt;&gt; klGamma(4, 2)  # Only the proportion between x and y is used  # doctest: +ELLIPSIS</span>
<span class="sd">    0.306852...</span>
<span class="sd">    &gt;&gt;&gt; klGamma(6, 8)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.037682...</span>

<span class="sd">    - x, y have to be positive:</span>

<span class="sd">    &gt;&gt;&gt; klGamma(-3, 2)</span>
<span class="sd">    inf</span>
<span class="sd">    &gt;&gt;&gt; klGamma(3, -2)</span>
<span class="sd">    inf</span>
<span class="sd">    &gt;&gt;&gt; klGamma(-3, -2)</span>
<span class="sd">    inf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;+inf&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">))</span></div>


<div class="viewcode-block" id="klNegBin"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klNegBin">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klNegBin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Kullback-Leibler divergence for negative binomial distributions. https://en.wikipedia.org/wiki/Negative_binomial_distribution</span>

<span class="sd">    .. math:: \mathrm{KL}(\mathrm{NegBin}(x, r), \mathrm{NegBin}(y, r)) = r \times \log((r + x) / (r + y)) - x \times \log(y \times (r + x) / (x \times (r + y))).</span>

<span class="sd">    .. warning:: The two distributions must have the same parameter r.</span>

<span class="sd">    &gt;&gt;&gt; klNegBin(0.5, 0.5)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; klNegBin(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.711611...</span>
<span class="sd">    &gt;&gt;&gt; klNegBin(0.9, 0.1)  # And this KL is non-symmetric  # doctest: +ELLIPSIS</span>
<span class="sd">    2.0321564...</span>
<span class="sd">    &gt;&gt;&gt; klNegBin(0.4, 0.5)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.130653...</span>
<span class="sd">    &gt;&gt;&gt; klNegBin(0.01, 0.99)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.717353...</span>

<span class="sd">    - Special values:</span>

<span class="sd">    &gt;&gt;&gt; klBern(0, 1)  # Should be +inf, but 0 --&gt; eps, 1 --&gt; 1 - eps  # doctest: +ELLIPSIS</span>
<span class="sd">    34.539575...</span>

<span class="sd">    - With other values for `r`:</span>

<span class="sd">    &gt;&gt;&gt; klNegBin(0.5, 0.5, r=2)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; klNegBin(0.1, 0.9, r=2)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.832991...</span>
<span class="sd">    &gt;&gt;&gt; klNegBin(0.1, 0.9, r=4)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.914890...</span>
<span class="sd">    &gt;&gt;&gt; klNegBin(0.9, 0.1, r=2)  # And this KL is non-symmetric  # doctest: +ELLIPSIS</span>
<span class="sd">    2.3325528...</span>
<span class="sd">    &gt;&gt;&gt; klNegBin(0.4, 0.5, r=2)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.154572...</span>
<span class="sd">    &gt;&gt;&gt; klNegBin(0.01, 0.99, r=2)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.836257...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span> <span class="o">*</span> <span class="n">log</span><span class="p">((</span><span class="n">r</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">y</span><span class="p">))</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">y</span><span class="p">)))</span></div>


<div class="viewcode-block" id="klGauss"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klGauss">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klGauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sig2x</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">sig2y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Kullback-Leibler divergence for Gaussian distributions of means ``x`` and ``y`` and variances ``sig2x`` and ``sig2y``, :math:`\nu_1 = \mathcal{N}(x, \sigma_x^2)` and :math:`\nu_2 = \mathcal{N}(y, \sigma_x^2)`:</span>

<span class="sd">    .. math:: \mathrm{KL}(\nu_1, \nu_2) = \frac{(x - y)^2}{2 \sigma_y^2} + \frac{1}{2}\left( \frac{\sigma_x^2}{\sigma_y^2} - 1 \log\left(\frac{\sigma_x^2}{\sigma_y^2}\right) \right).</span>

<span class="sd">    See https://en.wikipedia.org/wiki/Normal_distribution#Other_properties</span>

<span class="sd">    - By default, sig2y is assumed to be sig2x (same variance).</span>

<span class="sd">    .. warning:: The C version does not support different variances.</span>

<span class="sd">    &gt;&gt;&gt; klGauss(3, 3)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; klGauss(3, 6)</span>
<span class="sd">    18.0</span>
<span class="sd">    &gt;&gt;&gt; klGauss(1, 2)</span>
<span class="sd">    2.0</span>
<span class="sd">    &gt;&gt;&gt; klGauss(2, 1)  # And this KL is symmetric</span>
<span class="sd">    2.0</span>
<span class="sd">    &gt;&gt;&gt; klGauss(4, 2)</span>
<span class="sd">    8.0</span>
<span class="sd">    &gt;&gt;&gt; klGauss(6, 8)</span>
<span class="sd">    8.0</span>

<span class="sd">    - x, y can be negative:</span>

<span class="sd">    &gt;&gt;&gt; klGauss(-3, 2)</span>
<span class="sd">    50.0</span>
<span class="sd">    &gt;&gt;&gt; klGauss(3, -2)</span>
<span class="sd">    50.0</span>
<span class="sd">    &gt;&gt;&gt; klGauss(-3, -2)</span>
<span class="sd">    2.0</span>
<span class="sd">    &gt;&gt;&gt; klGauss(3, 2)</span>
<span class="sd">    2.0</span>

<span class="sd">    - With other values for `sig2x`:</span>

<span class="sd">    &gt;&gt;&gt; klGauss(3, 3, sig2x=10)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; klGauss(3, 6, sig2x=10)</span>
<span class="sd">    0.45</span>
<span class="sd">    &gt;&gt;&gt; klGauss(1, 2, sig2x=10)</span>
<span class="sd">    0.05</span>
<span class="sd">    &gt;&gt;&gt; klGauss(2, 1, sig2x=10)  # And this KL is symmetric</span>
<span class="sd">    0.05</span>
<span class="sd">    &gt;&gt;&gt; klGauss(4, 2, sig2x=10)</span>
<span class="sd">    0.2</span>
<span class="sd">    &gt;&gt;&gt; klGauss(6, 8, sig2x=10)</span>
<span class="sd">    0.2</span>

<span class="sd">    - With different values for `sig2x` and `sig2y`:</span>

<span class="sd">    &gt;&gt;&gt; klGauss(0, 0, sig2x=0.25, sig2y=0.5)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.0284...</span>
<span class="sd">    &gt;&gt;&gt; klGauss(0, 0, sig2x=0.25, sig2y=1.0)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.2243...</span>
<span class="sd">    &gt;&gt;&gt; klGauss(0, 0, sig2x=0.5, sig2y=0.25)  # not symmetric here!  # doctest: +ELLIPSIS</span>
<span class="sd">    1.1534...</span>

<span class="sd">    &gt;&gt;&gt; klGauss(0, 1, sig2x=0.25, sig2y=0.5)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.9715...</span>
<span class="sd">    &gt;&gt;&gt; klGauss(0, 1, sig2x=0.25, sig2y=1.0)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.7243...</span>
<span class="sd">    &gt;&gt;&gt; klGauss(0, 1, sig2x=0.5, sig2y=0.25)  # not symmetric here!  # doctest: +ELLIPSIS</span>
<span class="sd">    3.1534...</span>

<span class="sd">    &gt;&gt;&gt; klGauss(1, 0, sig2x=0.25, sig2y=0.5)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.9715...</span>
<span class="sd">    &gt;&gt;&gt; klGauss(1, 0, sig2x=0.25, sig2y=1.0)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.7243...</span>
<span class="sd">    &gt;&gt;&gt; klGauss(1, 0, sig2x=0.5, sig2y=0.25)  # not symmetric here!  # doctest: +ELLIPSIS</span>
<span class="sd">    3.1534...</span>

<span class="sd">    .. warning:: Using :class:`Policies.klUCB` (and variants) with :func:`klGauss` is equivalent to use :class:`Policies.UCB`, so prefer the simpler version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sig2y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="o">-</span> <span class="n">eps</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sig2y</span> <span class="o">-</span> <span class="n">sig2x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sig2x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sig2y</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">sig2x</span><span class="o">/</span><span class="n">sig2y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">log</span><span class="p">(</span><span class="n">sig2x</span><span class="o">/</span><span class="n">sig2y</span><span class="p">))</span></div>


<span class="c1"># --- KL functions, for the KL-UCB policy</span>

<div class="viewcode-block" id="klucb"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klucb">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klucb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">upperbound</span><span class="p">,</span>
        <span class="n">precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">lowerbound</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">),</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; The generic KL-UCB index computation.</span>

<span class="sd">    - ``x``: value of the cum reward,</span>
<span class="sd">    - ``d``: upper bound on the divergence,</span>
<span class="sd">    - ``kl``: the KL divergence to be used (:func:`klBern`, :func:`klGauss`, etc),</span>
<span class="sd">    - ``upperbound``, ``lowerbound=float(&#39;-inf&#39;)``: the known bound of the values ``x``,</span>
<span class="sd">    - ``precision=1e-6``: the threshold from where to stop the research,</span>
<span class="sd">    - ``max_iterations=50``: max number of iterations of the loop (safer to bound it to reduce time complexity).</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathrm{klucb}(x, d) \simeq \sup_{\mathrm{lowerbound} \leq y \leq \mathrm{upperbound}} \{ y : \mathrm{kl}(x, y) &lt; d \}.</span>

<span class="sd">    .. note:: It uses a **bisection search**, and one call to ``kl`` for each step of the bisection search.</span>

<span class="sd">    For example, for :func:`klucbBern`, the two steps are to first compute an upperbound (as precise as possible) and the compute the kl-UCB index:</span>

<span class="sd">    &gt;&gt;&gt; x, d = 0.9, 0.2   # mean x, exploration term d</span>
<span class="sd">    &gt;&gt;&gt; upperbound = min(1., klucbGauss(x, d, sig2x=0.25))  # variance 1/4 for [0,1] bounded distributions</span>
<span class="sd">    &gt;&gt;&gt; upperbound  # doctest: +ELLIPSIS</span>
<span class="sd">    1.0</span>
<span class="sd">    &gt;&gt;&gt; klucb(x, d, klBern, upperbound, lowerbound=0, precision=1e-3, max_iterations=10)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.9941...</span>
<span class="sd">    &gt;&gt;&gt; klucb(x, d, klBern, upperbound, lowerbound=0, precision=1e-6, max_iterations=10)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.9944...</span>
<span class="sd">    &gt;&gt;&gt; klucb(x, d, klBern, upperbound, lowerbound=0, precision=1e-3, max_iterations=50)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.9941...</span>
<span class="sd">    &gt;&gt;&gt; klucb(x, d, klBern, upperbound, lowerbound=0, precision=1e-6, max_iterations=100)  # more and more precise!  # doctest: +ELLIPSIS</span>
<span class="sd">    0.994489...</span>

<span class="sd">    .. note:: See below for more examples for different KL divergence functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lowerbound</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">upperbound</span>
    <span class="n">_count_iteration</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">_count_iteration</span> <span class="o">&lt;</span> <span class="n">max_iterations</span> <span class="ow">and</span> <span class="n">u</span> <span class="o">-</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">precision</span><span class="p">:</span>
        <span class="n">_count_iteration</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="k">if</span> <span class="n">kl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">m</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span></div>


<div class="viewcode-block" id="klucbBern"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klucbBern">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klucbBern</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; KL-UCB index computation for Bernoulli distributions, using :func:`klucb`.</span>

<span class="sd">    - Influence of x:</span>

<span class="sd">    &gt;&gt;&gt; klucbBern(0.1, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.378391...</span>
<span class="sd">    &gt;&gt;&gt; klucbBern(0.5, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.787088...</span>
<span class="sd">    &gt;&gt;&gt; klucbBern(0.9, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.994489...</span>

<span class="sd">    - Influence of d:</span>

<span class="sd">    &gt;&gt;&gt; klucbBern(0.1, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.519475...</span>
<span class="sd">    &gt;&gt;&gt; klucbBern(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.734714...</span>

<span class="sd">    &gt;&gt;&gt; klucbBern(0.5, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.871035...</span>
<span class="sd">    &gt;&gt;&gt; klucbBern(0.5, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.956809...</span>

<span class="sd">    &gt;&gt;&gt; klucbBern(0.9, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.999285...</span>
<span class="sd">    &gt;&gt;&gt; klucbBern(0.9, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.999995...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">upperbound</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">klucbGauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sig2x</span><span class="o">=</span><span class="mf">0.25</span><span class="p">))</span>  <span class="c1"># variance 1/4 for [0,1] bounded distributions</span>
    <span class="c1"># upperbound = min(1., klucbPoisson(x, d))  # also safe, and better ?</span>
    <span class="k">return</span> <span class="n">klucb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">klBern</span><span class="p">,</span> <span class="n">upperbound</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="klucbGauss"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klucbGauss">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klucbGauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sig2x</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; KL-UCB index computation for Gaussian distributions.</span>

<span class="sd">    - Note that it does not require any search.</span>

<span class="sd">    .. warning:: it works only if the good variance constant is given.</span>

<span class="sd">    - Influence of x:</span>

<span class="sd">    &gt;&gt;&gt; klucbGauss(0.1, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.416227...</span>
<span class="sd">    &gt;&gt;&gt; klucbGauss(0.5, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.816227...</span>
<span class="sd">    &gt;&gt;&gt; klucbGauss(0.9, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.216227...</span>

<span class="sd">    - Influence of d:</span>

<span class="sd">    &gt;&gt;&gt; klucbGauss(0.1, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.547213...</span>
<span class="sd">    &gt;&gt;&gt; klucbGauss(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.770820...</span>

<span class="sd">    &gt;&gt;&gt; klucbGauss(0.5, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.947213...</span>
<span class="sd">    &gt;&gt;&gt; klucbGauss(0.5, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.170820...</span>

<span class="sd">    &gt;&gt;&gt; klucbGauss(0.9, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.347213...</span>
<span class="sd">    &gt;&gt;&gt; klucbGauss(0.9, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.570820...</span>

<span class="sd">    .. warning:: Using :class:`Policies.klUCB` (and variants) with :func:`klucbGauss` is equivalent to use :class:`Policies.UCB`, so prefer the simpler version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sig2x</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span></div>


<div class="viewcode-block" id="klucbPoisson"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klucbPoisson">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klucbPoisson</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; KL-UCB index computation for Poisson distributions, using :func:`klucb`.</span>

<span class="sd">    - Influence of x:</span>

<span class="sd">    &gt;&gt;&gt; klucbPoisson(0.1, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.450523...</span>
<span class="sd">    &gt;&gt;&gt; klucbPoisson(0.5, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.089376...</span>
<span class="sd">    &gt;&gt;&gt; klucbPoisson(0.9, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.640112...</span>

<span class="sd">    - Influence of d:</span>

<span class="sd">    &gt;&gt;&gt; klucbPoisson(0.1, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.693684...</span>
<span class="sd">    &gt;&gt;&gt; klucbPoisson(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.252796...</span>

<span class="sd">    &gt;&gt;&gt; klucbPoisson(0.5, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.422933...</span>
<span class="sd">    &gt;&gt;&gt; klucbPoisson(0.5, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    2.122985...</span>

<span class="sd">    &gt;&gt;&gt; klucbPoisson(0.9, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    2.033691...</span>
<span class="sd">    &gt;&gt;&gt; klucbPoisson(0.9, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    2.831573...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">upperbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>  <span class="c1"># looks safe, to check: left (Gaussian) tail of Poisson dev</span>
    <span class="k">return</span> <span class="n">klucb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">klPoisson</span><span class="p">,</span> <span class="n">upperbound</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="klucbExp"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klucbExp">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klucbExp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; KL-UCB index computation for exponential distributions, using :func:`klucb`.</span>

<span class="sd">    - Influence of x:</span>

<span class="sd">    &gt;&gt;&gt; klucbExp(0.1, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.202741...</span>
<span class="sd">    &gt;&gt;&gt; klucbExp(0.5, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.013706...</span>
<span class="sd">    &gt;&gt;&gt; klucbExp(0.9, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.824671...</span>

<span class="sd">    - Influence of d:</span>

<span class="sd">    &gt;&gt;&gt; klucbExp(0.1, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.285792...</span>
<span class="sd">    &gt;&gt;&gt; klucbExp(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.559088...</span>

<span class="sd">    &gt;&gt;&gt; klucbExp(0.5, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.428962...</span>
<span class="sd">    &gt;&gt;&gt; klucbExp(0.5, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    2.795442...</span>

<span class="sd">    &gt;&gt;&gt; klucbExp(0.9, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    2.572132...</span>
<span class="sd">    &gt;&gt;&gt; klucbExp(0.9, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    5.031795...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mf">0.77</span><span class="p">:</span>  <span class="c1"># XXX where does this value come from?</span>
        <span class="n">upperbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
        <span class="c1"># safe, klexp(x,y) &gt;= e^2/(2*(1-2e/3)) if x=y(1-e)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">upperbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mf">1.61</span><span class="p">:</span>  <span class="c1"># XXX where does this value come from?</span>
        <span class="n">lowerbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lowerbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">klucb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">klGamma</span><span class="p">,</span> <span class="n">upperbound</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">lowerbound</span><span class="p">)</span></div>


<span class="c1"># FIXME this one is wrong!</span>
<div class="viewcode-block" id="klucbGamma"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.klucbGamma">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">klucbGamma</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; KL-UCB index computation for Gamma distributions, using :func:`klucb`.</span>

<span class="sd">    - Influence of x:</span>

<span class="sd">    &gt;&gt;&gt; klucbGamma(0.1, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.202...</span>
<span class="sd">    &gt;&gt;&gt; klucbGamma(0.5, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.013...</span>
<span class="sd">    &gt;&gt;&gt; klucbGamma(0.9, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.824...</span>

<span class="sd">    - Influence of d:</span>

<span class="sd">    &gt;&gt;&gt; klucbGamma(0.1, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.285...</span>
<span class="sd">    &gt;&gt;&gt; klucbGamma(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.559...</span>

<span class="sd">    &gt;&gt;&gt; klucbGamma(0.5, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.428...</span>
<span class="sd">    &gt;&gt;&gt; klucbGamma(0.5, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    2.795...</span>

<span class="sd">    &gt;&gt;&gt; klucbGamma(0.9, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    2.572...</span>
<span class="sd">    &gt;&gt;&gt; klucbGamma(0.9, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    5.031...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mf">0.77</span><span class="p">:</span>  <span class="c1"># XXX where does this value come from?</span>
        <span class="n">upperbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
        <span class="c1"># safe, klexp(x,y) &gt;= e^2/(2*(1-2e/3)) if x=y(1-e)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">upperbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mf">1.61</span><span class="p">:</span>  <span class="c1"># XXX where does this value come from?</span>
        <span class="n">lowerbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lowerbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
    <span class="c1"># FIXME specify the value for a !</span>
    <span class="k">return</span> <span class="n">klucb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">klGamma</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">upperbound</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="o">-</span><span class="mf">1e2</span><span class="p">,</span> <span class="n">lowerbound</span><span class="p">),</span> <span class="n">precision</span><span class="p">)</span></div>


<span class="c1"># --- KL functions, for the KL Lower Confidence Bound</span>

<div class="viewcode-block" id="kllcb"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.kllcb">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">kllcb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">lowerbound</span><span class="p">,</span>
        <span class="n">precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">upperbound</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;+inf&#39;</span><span class="p">),</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; The generic KL-LCB index computation.</span>

<span class="sd">    - ``x``: value of the cum reward,</span>
<span class="sd">    - ``d``: lower bound on the divergence,</span>
<span class="sd">    - ``kl``: the KL divergence to be used (:func:`klBern`, :func:`klGauss`, etc),</span>
<span class="sd">    - ``lowerbound``, ``upperbound=float(&#39;-inf&#39;)``: the known bound of the values ``x``,</span>
<span class="sd">    - ``precision=1e-6``: the threshold from where to stop the research,</span>
<span class="sd">    - ``max_iterations=50``: max number of iterations of the loop (safer to bound it to reduce time complexity).</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathrm{kllcb}(x, d) \simeq \inf_{\mathrm{lowerbound} \leq y \leq \mathrm{upperbound}} \{ y : \mathrm{kl}(x, y) &gt; d \}.</span>

<span class="sd">    .. note:: It uses a **bisection search**, and one call to ``kl`` for each step of the bisection search.</span>

<span class="sd">    For example, for :func:`kllcbBern`, the two steps are to first compute an upperbound (as precise as possible) and the compute the kl-UCB index:</span>

<span class="sd">    &gt;&gt;&gt; x, d = 0.9, 0.2   # mean x, exploration term d</span>
<span class="sd">    &gt;&gt;&gt; lowerbound = max(0., kllcbGauss(x, d, sig2x=0.25))  # variance 1/4 for [0,1] bounded distributions</span>
<span class="sd">    &gt;&gt;&gt; lowerbound  # doctest: +ELLIPSIS</span>
<span class="sd">    0.5837...</span>
<span class="sd">    &gt;&gt;&gt; kllcb(x, d, klBern, lowerbound, upperbound=0, precision=1e-3, max_iterations=10)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.29...</span>
<span class="sd">    &gt;&gt;&gt; kllcb(x, d, klBern, lowerbound, upperbound=0, precision=1e-6, max_iterations=10)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.29188...</span>
<span class="sd">    &gt;&gt;&gt; kllcb(x, d, klBern, lowerbound, upperbound=0, precision=1e-3, max_iterations=50)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.291886...</span>
<span class="sd">    &gt;&gt;&gt; kllcb(x, d, klBern, lowerbound, upperbound=0, precision=1e-6, max_iterations=100)  # more and more precise!  # doctest: +ELLIPSIS</span>
<span class="sd">    0.29188611...</span>

<span class="sd">    .. note:: See below for more examples for different KL divergence functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">upperbound</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">lowerbound</span>
    <span class="n">_count_iteration</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">_count_iteration</span> <span class="o">&lt;</span> <span class="n">max_iterations</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">-</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">precision</span><span class="p">:</span>
        <span class="n">_count_iteration</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="k">if</span> <span class="n">kl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">m</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span></div>


<div class="viewcode-block" id="kllcbBern"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.kllcbBern">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">kllcbBern</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; KL-LCB index computation for Bernoulli distributions, using :func:`kllcb`.</span>

<span class="sd">    - Influence of x:</span>

<span class="sd">    &gt;&gt;&gt; kllcbBern(0.1, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.09999...</span>
<span class="sd">    &gt;&gt;&gt; kllcbBern(0.5, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.49999...</span>
<span class="sd">    &gt;&gt;&gt; kllcbBern(0.9, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.89999...</span>

<span class="sd">    - Influence of d:</span>

<span class="sd">    &gt;&gt;&gt; kllcbBern(0.1, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.09999...</span>
<span class="sd">    &gt;&gt;&gt; kllcbBern(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.09999...</span>

<span class="sd">    &gt;&gt;&gt; kllcbBern(0.5, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.4999...</span>
<span class="sd">    &gt;&gt;&gt; kllcbBern(0.5, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.4999...</span>

<span class="sd">    &gt;&gt;&gt; kllcbBern(0.9, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.8999...</span>
<span class="sd">    &gt;&gt;&gt; kllcbBern(0.9, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.8999...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowerbound</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">kllcbGauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sig2x</span><span class="o">=</span><span class="mf">0.25</span><span class="p">))</span>  <span class="c1"># variance 1/4 for [0,1] bounded distributions</span>
    <span class="c1"># lowerbound = max(0., kllcbPoisson(x, d))  # also safe, and better ?</span>
    <span class="k">return</span> <span class="n">kllcb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">klBern</span><span class="p">,</span> <span class="n">lowerbound</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="kllcbGauss"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.kllcbGauss">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">kllcbGauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sig2x</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; KL-LCB index computation for Gaussian distributions.</span>

<span class="sd">    - Note that it does not require any search.</span>

<span class="sd">    .. warning:: it works only if the good variance constant is given.</span>

<span class="sd">    - Influence of x:</span>

<span class="sd">    &gt;&gt;&gt; kllcbGauss(0.1, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.21622...</span>
<span class="sd">    &gt;&gt;&gt; kllcbGauss(0.5, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.18377...</span>
<span class="sd">    &gt;&gt;&gt; kllcbGauss(0.9, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.58377...</span>

<span class="sd">    - Influence of d:</span>

<span class="sd">    &gt;&gt;&gt; kllcbGauss(0.1, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.3472...</span>
<span class="sd">    &gt;&gt;&gt; kllcbGauss(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.5708...</span>

<span class="sd">    &gt;&gt;&gt; kllcbGauss(0.5, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.0527...</span>
<span class="sd">    &gt;&gt;&gt; kllcbGauss(0.5, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    -0.1708...</span>

<span class="sd">    &gt;&gt;&gt; kllcbGauss(0.9, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.4527...</span>
<span class="sd">    &gt;&gt;&gt; kllcbGauss(0.9, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.2291...</span>

<span class="sd">    .. warning:: Using :class:`Policies.kllCB` (and variants) with :func:`kllcbGauss` is equivalent to use :class:`Policies.UCB`, so prefer the simpler version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sig2x</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span></div>


<div class="viewcode-block" id="kllcbPoisson"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.kllcbPoisson">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">kllcbPoisson</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; KL-LCB index computation for Poisson distributions, using :func:`kllcb`.</span>

<span class="sd">    - Influence of x:</span>

<span class="sd">    &gt;&gt;&gt; kllcbPoisson(0.1, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.09999...</span>
<span class="sd">    &gt;&gt;&gt; kllcbPoisson(0.5, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.49999...</span>
<span class="sd">    &gt;&gt;&gt; kllcbPoisson(0.9, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.89999...</span>

<span class="sd">    - Influence of d:</span>

<span class="sd">    &gt;&gt;&gt; kllcbPoisson(0.1, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.09999...</span>
<span class="sd">    &gt;&gt;&gt; kllcbPoisson(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.09999...</span>

<span class="sd">    &gt;&gt;&gt; kllcbPoisson(0.5, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.49999...</span>
<span class="sd">    &gt;&gt;&gt; kllcbPoisson(0.5, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.49999...</span>

<span class="sd">    &gt;&gt;&gt; kllcbPoisson(0.9, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.89999...</span>
<span class="sd">    &gt;&gt;&gt; kllcbPoisson(0.9, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.89999...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowerbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">d</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>  <span class="c1"># looks safe, to check: left (Gaussian) tail of Poisson dev</span>
    <span class="k">return</span> <span class="n">kllcb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">klPoisson</span><span class="p">,</span> <span class="n">lowerbound</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="kllcbExp"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.kllcbExp">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">kllcbExp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; KL-LCB index computation for exponential distributions, using :func:`kllcb`.</span>

<span class="sd">    - Influence of x:</span>

<span class="sd">    &gt;&gt;&gt; kllcbExp(0.1, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.15267...</span>
<span class="sd">    &gt;&gt;&gt; kllcbExp(0.5, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.7633...</span>
<span class="sd">    &gt;&gt;&gt; kllcbExp(0.9, 0.2)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.3740...</span>

<span class="sd">    - Influence of d:</span>

<span class="sd">    &gt;&gt;&gt; kllcbExp(0.1, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.2000...</span>
<span class="sd">    &gt;&gt;&gt; kllcbExp(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    0.3842...</span>

<span class="sd">    &gt;&gt;&gt; kllcbExp(0.5, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.0000...</span>
<span class="sd">    &gt;&gt;&gt; kllcbExp(0.5, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.9214...</span>

<span class="sd">    &gt;&gt;&gt; kllcbExp(0.9, 0.4)  # doctest: +ELLIPSIS</span>
<span class="sd">    1.8000...</span>
<span class="sd">    &gt;&gt;&gt; kllcbExp(0.9, 0.9)  # doctest: +ELLIPSIS</span>
<span class="sd">    3.4586...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mf">0.77</span><span class="p">:</span>  <span class="c1"># XXX where does this value come from?</span>
        <span class="n">lowerbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
        <span class="c1"># safe, klexp(x,y) &gt;= e^2/(2*(1-2e/3)) if x=y(1-e)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lowerbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mf">1.61</span><span class="p">:</span>  <span class="c1"># XXX where does this value come from?</span>
        <span class="n">upperbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">upperbound</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">kllcb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">klGamma</span><span class="p">,</span> <span class="n">lowerbound</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">upperbound</span><span class="p">)</span></div>


<span class="c1"># # FIXME this one is wrong!</span>
<span class="c1"># @jit</span>
<span class="c1"># def kllcbGamma(x, d, precision=1e-6):</span>
<span class="c1">#     &quot;&quot;&quot; KL-LCB index computation for Gamma distributions, using :func:`kllcb`.</span>

<span class="c1">#     - Influence of x:</span>

<span class="c1">#     &gt;&gt;&gt; kllcbGamma(0.1, 0.2)  # doctest: +ELLIPSIS</span>
<span class="c1">#     0.202...</span>
<span class="c1">#     &gt;&gt;&gt; kllcbGamma(0.5, 0.2)  # doctest: +ELLIPSIS</span>
<span class="c1">#     1.013...</span>
<span class="c1">#     &gt;&gt;&gt; kllcbGamma(0.9, 0.2)  # doctest: +ELLIPSIS</span>
<span class="c1">#     1.824...</span>

<span class="c1">#     - Influence of d:</span>

<span class="c1">#     &gt;&gt;&gt; kllcbGamma(0.1, 0.4)  # doctest: +ELLIPSIS</span>
<span class="c1">#     0.285...</span>
<span class="c1">#     &gt;&gt;&gt; kllcbGamma(0.1, 0.9)  # doctest: +ELLIPSIS</span>
<span class="c1">#     0.559...</span>

<span class="c1">#     &gt;&gt;&gt; kllcbGamma(0.5, 0.4)  # doctest: +ELLIPSIS</span>
<span class="c1">#     1.428...</span>
<span class="c1">#     &gt;&gt;&gt; kllcbGamma(0.5, 0.9)  # doctest: +ELLIPSIS</span>
<span class="c1">#     2.795...</span>

<span class="c1">#     &gt;&gt;&gt; kllcbGamma(0.9, 0.4)  # doctest: +ELLIPSIS</span>
<span class="c1">#     2.572...</span>
<span class="c1">#     &gt;&gt;&gt; kllcbGamma(0.9, 0.9)  # doctest: +ELLIPSIS</span>
<span class="c1">#     5.031...</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     if d &lt; 0.77:  # XXX where does this value come from?</span>
<span class="c1">#         lowerbound = x / (1 + 2. / 3 * d - sqrt(4. / 9 * d * d + 2 * d))</span>
<span class="c1">#         # safe, klexp(x,y) &gt;= e^2/(2*(1-2e/3)) if x=y(1-e)</span>
<span class="c1">#     else:</span>
<span class="c1">#         lowerbound = x * exp(d + 1)</span>
<span class="c1">#     if d &gt; 1.61:  # XXX where does this value come from?</span>
<span class="c1">#         upperbound = x * exp(d)</span>
<span class="c1">#     else:</span>
<span class="c1">#         upperbound = x / (1 + d - sqrt(d * d + 2 * d))</span>
<span class="c1">#     # FIXME specify the value for a !</span>
<span class="c1">#     return kllcb(x, d, klGamma, min(lowerbound, -1e2), precision, max(1e2, upperbound))</span>


<span class="c1"># --- max EV functions</span>

<div class="viewcode-block" id="maxEV"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.maxEV">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">maxEV</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">klMax</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Maximize expectation of :math:`V` with respect to :math:`q` st. :math:`\mathrm{KL}(p, q) &lt; \text{klMax}`.</span>

<span class="sd">    - Input args.: p, V, klMax.</span>
<span class="sd">    - Reference: Section 3.2 of [Filippi, CappÃ© &amp; Garivier - Allerton, 2011](https://arxiv.org/pdf/1004.5229.pdf).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Uq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="n">Kb</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.</span>
    <span class="n">K</span> <span class="o">=</span> <span class="o">~</span><span class="n">Kb</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
        <span class="c1"># Do we need to put some mass on a point where p is zero?</span>
        <span class="c1"># If yes, this has to be on one which maximizes V.</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">K</span><span class="p">])</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">K</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V</span> <span class="o">==</span> <span class="n">eta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eta</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">Kb</span><span class="p">]):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">Kb</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eta</span> <span class="o">-</span> <span class="n">V</span><span class="p">[</span><span class="n">Kb</span><span class="p">]))</span> <span class="o">+</span> <span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">Kb</span><span class="p">],</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">eta</span> <span class="o">-</span> <span class="n">V</span><span class="p">[</span><span class="n">Kb</span><span class="p">]))))</span>
            <span class="c1"># print(&quot;eta = &quot;, eta, &quot;, y = &quot;, y)</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">klMax</span><span class="p">:</span>
                <span class="n">rb</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">klMax</span><span class="p">)</span>
                <span class="n">Uqtemp</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">Kb</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">eta</span> <span class="o">-</span> <span class="n">V</span><span class="p">[</span><span class="n">Kb</span><span class="p">])</span>
                <span class="n">Uq</span><span class="p">[</span><span class="n">Kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">*</span> <span class="n">Uqtemp</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Uqtemp</span><span class="p">)</span>
                <span class="n">Uq</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">rb</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
                <span class="c1"># or j = min([j for j in range(k) if J[j]])</span>
                <span class="c1"># Uq[j] = r</span>
                <span class="k">return</span> <span class="n">Uq</span>
    <span class="c1"># Here, only points where p is strictly positive (in Kb) will receive non-zero mass.</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">Kb</span><span class="p">]</span> <span class="o">-</span> <span class="n">V</span><span class="p">[</span><span class="n">Kb</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">):</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">reseqp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">Kb</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="n">Kb</span><span class="p">],</span> <span class="n">klMax</span><span class="p">)</span>  <span class="c1"># (eta = nu in the article)</span>
        <span class="n">Uq</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">eta</span> <span class="o">-</span> <span class="n">V</span><span class="p">)</span>
        <span class="n">Uq</span> <span class="o">=</span> <span class="n">Uq</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Uq</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Case where all values in V(Kb) are almost identical.</span>
        <span class="n">Uq</span><span class="p">[</span><span class="n">Kb</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">Kb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Uq</span></div>


<div class="viewcode-block" id="reseqp"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.reseqp">[docs]</a><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">reseqp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">klMax</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Solve ``f(reseqp(p, V, klMax)) = klMax``, using Newton method.</span>

<span class="sd">    .. note:: This is a subroutine of :func:`maxEV`.</span>

<span class="sd">    - Reference: Eq. (4) in Section 3.2 of [Filippi, CappÃ© &amp; Garivier - Allerton, 2011](https://arxiv.org/pdf/1004.5229.pdf).</span>

<span class="sd">    .. warning:: `np.dot` is very slow!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">mV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">MV</span> <span class="o">+</span> <span class="mf">0.1</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-4</span>
    <span class="k">if</span> <span class="n">MV</span> <span class="o">&lt;</span> <span class="n">mV</span> <span class="o">+</span> <span class="n">tol</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">V</span><span class="p">)))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">V</span><span class="p">))</span> <span class="o">+</span> <span class="n">log</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="n">klMax</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;value =&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;, y = &quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># DEBUG</span>
    <span class="n">_count_iteration</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">_count_iteration</span> <span class="o">&lt;</span> <span class="n">max_iterations</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">_count_iteration</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">yp</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">V</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">u</span>  <span class="c1"># derivative</span>
        <span class="n">value</span> <span class="o">-=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">yp</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;value = &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># DEBUG  # newton iteration</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">MV</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">y</span> <span class="o">/</span> <span class="n">yp</span> <span class="o">+</span> <span class="n">MV</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># unlikely, but not impossible</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">V</span><span class="p">)))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">V</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="n">klMax</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;value = &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;, y = &quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># DEBUG  # function</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="reseqp2"><a class="viewcode-back" href="../../docs/Arms.kullback.html#Arms.kullback.reseqp2">[docs]</a><span class="k">def</span> <span class="nf">reseqp2</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">klMax</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Solve f(reseqp(p, V, klMax)) = klMax, using a blackbox minimizer, from scipy.optimize.</span>

<span class="sd">    - FIXME it does not work well yet!</span>

<span class="sd">    .. note:: This is a subroutine of :func:`maxEV`.</span>

<span class="sd">    - Reference: Eq. (4) in Section 3.2 of [Filippi, CappÃ© &amp; Garivier - Allerton, 2011].</span>

<span class="sd">    .. warning:: `np.dot` is very slow!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">mV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-4</span>
    <span class="n">value0</span> <span class="o">=</span> <span class="n">mV</span> <span class="o">+</span> <span class="mf">0.1</span>

    <span class="nd">@jit</span>  <span class="c1"># TODO try numba.jit() on this function</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function fo to minimize.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">MV</span> <span class="o">&lt;</span> <span class="n">mV</span> <span class="o">+</span> <span class="n">tol</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">V</span><span class="p">)))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">V</span><span class="p">))</span> <span class="o">+</span> <span class="n">log</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">klMax</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">value0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scipy.optimize.minimize returned&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">res</span></div>


<span class="c1"># --- Debugging</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Code for debugging purposes.</span>
    <span class="kn">from</span> <span class="nn">doctest</span> <span class="k">import</span> <span class="n">testmod</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Testing automatically all the docstring written in each functions of this module :&quot;</span><span class="p">)</span>
    <span class="n">testmod</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># import matplotlib.pyplot as plt</span>
    <span class="c1"># t = np.linspace(0, 1)</span>
    <span class="c1"># plt.subplot(2, 1, 1)</span>
    <span class="c1"># plt.plot(t, kl(t, 0.6))</span>
    <span class="c1"># plt.subplot(2, 1, 2)</span>
    <span class="c1"># d = np.linspace(0, 1, 100)</span>
    <span class="c1"># plt.plot(d, [klucb(0.3, dd) for dd in d])</span>
    <span class="c1"># plt.show()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">klucbGauss(0.9, 0.2) =&quot;</span><span class="p">,</span> <span class="n">klucbGauss</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;klucbBern(0.9, 0.2) =&quot;</span><span class="p">,</span> <span class="n">klucbBern</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;klucbPoisson(0.9, 0.2) =&quot;</span><span class="p">,</span> <span class="n">klucbPoisson</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">p =&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;V =&quot;</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
    <span class="n">klMax</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;klMax =&quot;</span><span class="p">,</span> <span class="n">klMax</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;eta = &quot;</span><span class="p">,</span> <span class="n">reseqp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">klMax</span><span class="p">))</span>
    <span class="c1"># print(&quot;eta 2 = &quot;, reseqp2(p, V, klMax))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Uq = &quot;</span><span class="p">,</span> <span class="n">maxEV</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">klMax</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">p =&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.11794872</span><span class="p">,</span> <span class="mf">0.27948718</span><span class="p">,</span> <span class="mf">0.31538462</span><span class="p">,</span> <span class="mf">0.14102564</span><span class="p">,</span> <span class="mf">0.0974359</span><span class="p">,</span> <span class="mf">0.03076923</span><span class="p">,</span> <span class="mf">0.00769231</span><span class="p">,</span> <span class="mf">0.01025641</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;V =&quot;</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
    <span class="n">klMax</span> <span class="o">=</span> <span class="mf">0.0168913409484</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;klMax =&quot;</span><span class="p">,</span> <span class="n">klMax</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;eta = &quot;</span><span class="p">,</span> <span class="n">reseqp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">klMax</span><span class="p">))</span>
    <span class="c1"># print(&quot;eta 2 = &quot;, reseqp2(p, V, klMax))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Uq = &quot;</span><span class="p">,</span> <span class="n">maxEV</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">klMax</span><span class="p">))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">x =&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mf">2.51</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;d =&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;klucbExp(x, d) = &quot;</span><span class="p">,</span> <span class="n">klucbExp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>

    <span class="n">ub</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Upper bound = &quot;</span><span class="p">,</span> <span class="n">ub</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stupid upperbound = &quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done for tests of &#39;kullback.py&#39; ...&quot;</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2018, Lilian Besson (Naereen)
      <span class="lastupdated">
        Last updated on 10 Apr 2019, 14h.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>